const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/server-DUznqEvH.js","assets/main-DS40ZeVL.js","assets/styles-rklHBh97.css"])))=>i.map(i=>d[i]);
import{r as qe,_ as Pr,j as se}from"./main-DS40ZeVL.js";import{o as w,b as Z,n as zt,s as p,c as Ue,e as Bt,d as k,a as Ye,f as $e,r as ct,g as Mt}from"./types-B8YapRiX.js";var Cr=Object.defineProperty,zr=Object.defineProperties,Br=Object.getOwnPropertyDescriptors,gt=Object.getOwnPropertySymbols,Mr=Object.prototype.hasOwnProperty,Vr=Object.prototype.propertyIsEnumerable,wt=(e,t,r)=>t in e?Cr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,H=(e,t)=>{for(var r in t||(t={}))Mr.call(t,r)&&wt(e,r,t[r]);if(gt)for(var r of gt(t))Vr.call(t,r)&&wt(e,r,t[r]);return e},K=(e,t)=>zr(e,Br(t)),$r=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},jr=async(e,t)=>{var r,n,i,o,s,a;let c=t||{};const u={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:c,hooks:u};for(const d of t?.plugins||[]){if(d.init){const l=await((r=d.init)==null?void 0:r.call(d,e.toString(),t));c=l.options||c,e=l.url}u.onRequest.push((n=d.hooks)==null?void 0:n.onRequest),u.onResponse.push((i=d.hooks)==null?void 0:i.onResponse),u.onSuccess.push((o=d.hooks)==null?void 0:o.onSuccess),u.onError.push((s=d.hooks)==null?void 0:s.onError),u.onRetry.push((a=d.hooks)==null?void 0:a.onRetry)}return{url:e,options:c,hooks:u}},yt=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},Hr=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function xr(e){if(typeof e=="number")return new yt({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new yt(e);case"exponential":return new Hr(e);default:throw new Error("Invalid retry strategy")}}var qr=async e=>{const t={},r=async n=>typeof n=="function"?await n():n;if(e?.auth){if(e.auth.type==="Bearer"){const n=await r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){const n=r(e.auth.username),i=r(e.auth.password);if(!n||!i)return t;t.authorization=`Basic ${btoa(`${n}:${i}`)}`}else if(e.auth.type==="Custom"){const n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},Wr=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function Kr(e){const t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";const n=t.split(";").shift()||"";return Wr.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function Jr(e){try{return JSON.parse(e),!0}catch{return!1}}function Vt(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function Et(e){try{return JSON.parse(e)}catch{return e}}function Tt(e){return typeof e=="function"}function Fr(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&Tt(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&Tt(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}async function Gr(e){const t=new Headers(e?.headers),r=await qr(e);for(const[n,i]of Object.entries(r||{}))t.set(n,i);if(!t.has("content-type")){const n=Zr(e?.body);n&&t.set("content-type",n)}return t}function Zr(e){return Vt(e)?"application/json":null}function Qr(e){if(!e?.body)return null;const t=new Headers(e?.headers);if(Vt(e.body)&&!t.has("content-type")){for(const[r,n]of Object.entries(e?.body))n instanceof Date&&(e.body[r]=n.toISOString());return JSON.stringify(e.body)}return e.body}function Yr(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){const n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return jt.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function Xr(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}var en=class $t extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,$t.prototype)}};async function Me(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new en(r.issues);return r.value}var jt=["get","post","put","patch","delete"],tn=e=>({id:"apply-schema",name:"Apply Schema",version:"1.0.0",async init(t,r){var n,i,o,s;const a=((i=(n=e.plugins)==null?void 0:n.find(c=>{var u;return(u=c.schema)!=null&&u.config?t.startsWith(c.schema.config.baseURL||"")||t.startsWith(c.schema.config.prefix||""):!1}))==null?void 0:i.schema)||e.schema;if(a){let c=t;(o=a.config)!=null&&o.prefix&&c.startsWith(a.config.prefix)&&(c=c.replace(a.config.prefix,""),a.config.baseURL&&(t=t.replace(a.config.prefix,a.config.baseURL))),(s=a.config)!=null&&s.baseURL&&c.startsWith(a.config.baseURL)&&(c=c.replace(a.config.baseURL,""));const u=a.schema[c];if(u){let d=K(H({},r),{method:u.method,output:u.output});return r?.disableValidation||(d=K(H({},d),{body:u.input?await Me(u.input,r?.body):r?.body,params:u.params?await Me(u.params,r?.params):r?.params,query:u.query?await Me(u.query,r?.query):r?.query})),{url:t,options:d}}}return{url:t,options:r}}}),rn=e=>{async function t(r,n){const i=K(H(H({},e),n),{plugins:[...e?.plugins||[],tn(e||{})]});if(e?.catchAllError)try{return await O(r,i)}catch(o){return{data:null,error:{status:500,statusText:"Fetch Error",message:"Fetch related error. Captured by catchAllError option. See error property for more details.",error:o}}}return await O(r,i)}return t};function nn(e,t){let{baseURL:r,params:n,query:i}=t||{query:{},params:{},baseURL:""},o=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){const l=e.toString().split("@")[1].split("/")[0];jt.includes(l)&&(e=e.replace(`@${l}/`,"/"))}o.endsWith("/")||(o+="/");let[s,a]=e.replace(o,"").split("?");const c=new URLSearchParams(a);for(const[l,m]of Object.entries(i||{}))m!=null&&c.set(l,String(m));if(n)if(Array.isArray(n)){const l=s.split("/").filter(m=>m.startsWith(":"));for(const[m,h]of l.entries()){const g=n[m];s=s.replace(h,g)}}else for(const[l,m]of Object.entries(n))s=s.replace(`:${l}`,String(m));s=s.split("/").map(encodeURIComponent).join("/"),s.startsWith("/")&&(s=s.slice(1));let u=c.toString();return u=u.length>0?`?${u}`.replace(/\+/g,"%20"):"",o.startsWith("http")?new URL(`${s}${u}`,o):`${o}${s}${u}`}var O=async(e,t)=>{var r,n,i,o,s,a,c,u;const{hooks:d,url:l,options:m}=await jr(e,t),h=Fr(m),g=new AbortController,E=(r=m.signal)!=null?r:g.signal,I=nn(l,m),v=Qr(m),_=await Gr(m),P=Yr(l,m);let S=K(H({},m),{url:I,headers:_,body:v,method:P,signal:E});for(const V of d.onRequest)if(V){const C=await V(S);C instanceof Object&&(S=C)}("pipeTo"in S&&typeof S.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in S||(S.duplex="half"));const{clearTimeout:Q}=Xr(m,g);let b=await h(S.url,S);Q();const q={response:b,request:S};for(const V of d.onResponse)if(V){const C=await V(K(H({},q),{response:(i=t?.hookOptions)!=null&&i.cloneResponse?b.clone():b}));C instanceof Response?b=C:C instanceof Object&&(b=C.response)}if(b.ok){if(!(S.method!=="HEAD"))return{data:"",error:null};const C=Kr(b),Y={data:"",response:b,request:S};if(C==="json"||C==="text"){const X=await b.text(),Lr=await((o=S.jsonParser)!=null?o:Et)(X);Y.data=Lr}else Y.data=await b[C]();S?.output&&S.output&&!S.disableValidation&&(Y.data=await Me(S.output,Y.data));for(const X of d.onSuccess)X&&await X(K(H({},Y),{response:(s=t?.hookOptions)!=null&&s.cloneResponse?b.clone():b}));return t?.throw?Y.data:{data:Y.data,error:null}}const Se=(a=t?.jsonParser)!=null?a:Et,oe=await b.text(),ge=Jr(oe),Le=ge?await Se(oe):null,xe={response:b,responseText:oe,request:S,error:K(H({},Le),{status:b.status,statusText:b.statusText})};for(const V of d.onError)V&&await V(K(H({},xe),{response:(c=t?.hookOptions)!=null&&c.cloneResponse?b.clone():b}));if(t?.retry){const V=xr(t.retry),C=(u=t.retryAttempt)!=null?u:0;if(await V.shouldAttemptRetry(C,b)){for(const X of d.onRetry)X&&await X(q);const Y=V.getDelay(C);return await new Promise(X=>setTimeout(X,Y)),await O(e,K(H({},t),{retryAttempt:C+1}))}}if(t?.throw)throw new $r(b.status,b.statusText,ge?Le:oe);return{data:null,error:K(H({},Le),{status:b.status,statusText:b.statusText})}},on={},sn={};const Ve=Object.create(null),Oe=e=>on||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?Ve:globalThis),ce=new Proxy(Ve,{get(e,t){return Oe()[t]??Ve[t]},has(e,t){const r=Oe();return t in r||t in Ve},set(e,t,r){const n=Oe(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;const r=Oe(!0);return delete r[t],!0},ownKeys(){const e=Oe(!0);return Object.keys(e)}});function an(e){return e?e!=="false":!1}const Xe=typeof process<"u"&&sn&&"production"||"",cn=Xe==="dev"||Xe==="development";Xe==="test"||an(ce.TEST);class Te extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}}function dn(e){try{return new URL(e).pathname!=="/"}catch{throw new Te(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function We(e,t="/api/auth"){return dn(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e.replace(/\/+$/,"")}${t}`)}function un(e,t,r){if(e)return We(e,t);const n=ce.BETTER_AUTH_URL||ce.NEXT_PUBLIC_BETTER_AUTH_URL||ce.PUBLIC_BETTER_AUTH_URL||ce.NUXT_PUBLIC_BETTER_AUTH_URL||ce.NUXT_PUBLIC_AUTH_URL||(ce.BASE_URL!=="/"?ce.BASE_URL:void 0);if(n)return We(n,t);if(typeof window<"u"&&window.location)return We(window.location.origin,t)}function Ht(e){try{return new URL(e).origin}catch{return null}}function xt(e){try{return new URL(e).protocol}catch{return null}}function qt(e){try{return new URL(e).host}catch{return e}}let j=[],ae=0;const Pe=4;let Wt=e=>{let t=[],r={get(){return r.lc||r.listen(()=>{})(),r.value},lc:0,listen(n){return r.lc=t.push(n),()=>{for(let o=ae+Pe;o<j.length;)j[o]===n?j.splice(o,Pe):o+=Pe;let i=t.indexOf(n);~i&&(t.splice(i,1),--r.lc||r.off())}},notify(n,i){let o=!j.length;for(let s of t)j.push(s,r.value,n,i);if(o){for(ae=0;ae<j.length;ae+=Pe)j[ae](j[ae+1],j[ae+2],j[ae+3]);j.length=0}},off(){},set(n){let i=r.value;i!==n&&(r.value=n,r.notify(i))},subscribe(n){let i=r.listen(n);return n(r.value),i},value:e};return r};const ln=5,Ce=6,ze=10;let fn=(e,t,r,n)=>(e.events=e.events||{},e.events[r+ze]||(e.events[r+ze]=n(i=>{e.events[r].reduceRight((o,s)=>(s(o),o),{shared:{},...i})})),e.events[r]=e.events[r]||[],e.events[r].push(t),()=>{let i=e.events[r],o=i.indexOf(t);i.splice(o,1),i.length||(delete e.events[r],e.events[r+ze](),delete e.events[r+ze])}),pn=1e3,mn=(e,t)=>fn(e,n=>{let i=t(n);i&&e.events[Ce].push(i)},ln,n=>{let i=e.listen;e.listen=(...s)=>(!e.lc&&!e.active&&(e.active=!0,n()),i(...s));let o=e.off;return e.events[Ce]=[],e.off=()=>{o(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let s of e.events[Ce])s();e.events[Ce]=[]}},pn)},()=>{e.listen=i,e.off=o}});function hn(e,t,r){let n=new Set(t).add(void 0);return e.listen((i,o,s)=>{n.has(s)&&r(i,o,s)})}const gn=typeof window>"u",wn=(e,t,r,n)=>{const i=Wt({data:null,error:null,isPending:!0,isRefetching:!1,refetch:()=>o()}),o=()=>{const a=typeof n=="function"?n({data:i.get().data,error:i.get().error,isPending:i.get().isPending}):n;return r(t,{...a,async onSuccess(c){i.set({data:c.data,error:null,isPending:!1,isRefetching:!1,refetch:i.value.refetch}),await a?.onSuccess?.(c)},async onError(c){const{request:u}=c,d=typeof u.retry=="number"?u.retry:u.retry?.attempts,l=u.retryAttempt||0;d&&l<d||(i.set({error:c.error,data:null,isPending:!1,isRefetching:!1,refetch:i.value.refetch}),await a?.onError?.(c))},async onRequest(c){const u=i.get();i.set({isPending:u.data===null,data:u.data,error:null,isRefetching:!0,refetch:i.value.refetch}),await a?.onRequest?.(c)}})};e=Array.isArray(e)?e:[e];let s=!1;for(const a of e)a.subscribe(()=>{gn||(s?o():mn(i,()=>(setTimeout(()=>{o()},0),s=!0,()=>{i.off(),a.off()})))});return i},yn={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},En=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,At={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},Tn=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function An(e){return e instanceof Date&&!isNaN(e.getTime())}function bn(e){const t=Tn.exec(e);if(!t)return null;const[,r,n,i,o,s,a,c,u,d,l]=t;let m=new Date(Date.UTC(parseInt(r,10),parseInt(n,10)-1,parseInt(i,10),parseInt(o,10),parseInt(s,10),parseInt(a,10),c?parseInt(c.padEnd(3,"0"),10):0));if(u){const h=(parseInt(d,10)*60+parseInt(l,10))*(u==="+"?-1:1);m.setUTCMinutes(m.getUTCMinutes()+h)}return An(m)?m:null}function _n(e,t={}){const{strict:r=!1,warnings:n=!1,reviver:i,parseDates:o=!0}=t;if(typeof e!="string")return e;const s=e.trim();if(s[0]==='"'&&s.endsWith('"')&&!s.slice(1,-1).includes('"'))return s.slice(1,-1);const a=s.toLowerCase();if(a.length<=9&&a in At)return At[a];if(!En.test(s)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(yn).some(([u,d])=>{const l=d.test(s);return l&&n&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${u} pattern`),l})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(s,(d,l)=>{if(d==="__proto__"||d==="constructor"&&l&&typeof l=="object"&&"prototype"in l){n&&console.warn(`[better-json] Dropping "${d}" key to prevent prototype pollution`);return}if(o&&typeof l=="string"){const m=bn(l);if(m)return m}return i?i(d,l):l})}catch(u){if(r)throw u;return e}}function Kt(e,t={strict:!0}){return _n(e,t)}const In={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}};function Sn(e){const t=Wt(!1);return{session:wn(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}const On=e=>{const t="credentials"in Request.prototype,r=un(e?.baseURL,e?.basePath),n=e?.plugins?.flatMap(h=>h.fetchPlugins).filter(h=>h!==void 0)||[],i=rn({baseURL:r,...t?{credentials:"include"}:{},method:"GET",jsonParser(h){return h?Kt(h,{strict:!1}):null},customFetchImpl:async(h,g)=>{try{return await fetch(h,g)}catch{return Response.error()}},...e?.fetchOptions,plugins:e?.disableDefaultFetchPlugins?[...e?.fetchOptions?.plugins||[],...n]:[In,...e?.fetchOptions?.plugins||[],...n]}),{$sessionSignal:o,session:s}=Sn(i),a=e?.plugins||[];let c={},u={$sessionSignal:o,session:s},d={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST","/delete-user":"POST"};const l=[{signal:"$sessionSignal",matcher(h){return h==="/sign-out"||h==="/update-user"||h.startsWith("/sign-in")||h.startsWith("/sign-up")||h==="/delete-user"||h==="/verify-email"}}];for(const h of a)h.getAtoms&&Object.assign(u,h.getAtoms?.(i)),h.pathMethods&&Object.assign(d,h.pathMethods),h.atomListeners&&l.push(...h.atomListeners);const m={notify:h=>{u[h].set(!u[h].get())},listen:(h,g)=>{u[h].subscribe(g)},atoms:u};for(const h of a)h.getActions&&Object.assign(c,h.getActions?.(i,m,e));return{pluginsActions:c,pluginsAtoms:u,pluginPathMethods:d,atomListeners:l,$fetch:i,$store:m}};function Rn(e,t,r){const n=t[e],{fetchOptions:i,query:o,...s}=r||{};return n||(i?.method?i.method:s&&Object.keys(s).length>0?"POST":"GET")}function vn(e,t,r,n,i){function o(s=[]){return new Proxy(function(){},{get(a,c){const u=[...s,c];let d=e;for(const l of u)if(d&&typeof d=="object"&&l in d)d=d[l];else{d=void 0;break}return typeof d=="function"?d:o(u)},apply:async(a,c,u)=>{const d="/"+s.map(_=>_.replace(/[A-Z]/g,P=>`-${P.toLowerCase()}`)).join("/"),l=u[0]||{},m=u[1]||{},{query:h,fetchOptions:g,...E}=l,I={...m,...g},v=Rn(d,r,l);return await t(d,{...I,body:v==="GET"?void 0:{...E,...I?.body||{}},query:h||I?.query,method:v,async onSuccess(_){await I?.onSuccess?.(_);const P=i?.find(b=>b.matcher(d));if(!P)return;const S=n[P.signal];if(!S)return;const Q=S.get();setTimeout(()=>{S.set(!Q)},10)}})}})}return o()}function kn(e,t={}){let r=qe.useRef(e.get());const{keys:n,deps:i=[e,n]}=t;let o=qe.useCallback(a=>{const c=u=>{r.current!==u&&(r.current=u,a())};return c(e.value),n?.length?hn(e,n,c):e.listen(c)},i),s=()=>r.current;return qe.useSyncExternalStore(o,s,s)}function Un(e){return`use${Nn(e)}`}function Nn(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Dn(e){const{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:n,$fetch:i,$store:o,atomListeners:s}=On(e);let a={};for(const[d,l]of Object.entries(n))a[Un(d)]=()=>kn(l);const c={...r,...a,$fetch:i,$store:o};return vn(c,i,t,n,s)}function je(e){return e?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}function Jt(e,t,r){let n="",i=0,o=0;for(const s of e)for(i=i<<8|s,o+=8;o>=6;)o-=6,n+=t[i>>o&63];if(o>0&&(n+=t[i<<6-o&63]),r){const s=(4-n.length%4)%4;n+="=".repeat(s)}return n}function Ft(e,t){const r=new Map;for(let s=0;s<t.length;s++)r.set(t[s],s);const n=[];let i=0,o=0;for(const s of e){if(s==="=")break;const a=r.get(s);if(a===void 0)throw new Error(`Invalid Base64 character: ${s}`);i=i<<6|a,o+=6,o>=8&&(o-=8,n.push(i>>o&255))}return Uint8Array.from(n)}const He={encode(e,t={}){const r=je(!1),n=typeof e=="string"?new TextEncoder().encode(e):new Uint8Array(e);return Jt(n,r,t.padding??!0)},decode(e){typeof e!="string"&&(e=new TextDecoder().decode(e));const t=e.includes("-")||e.includes("_"),r=je(t);return Ft(e,r)}},Ne={encode(e,t={}){const r=je(!0),n=typeof e=="string"?new TextEncoder().encode(e):new Uint8Array(e);return Jt(n,r,t.padding??!0)},decode(e){const t=e.includes("-")||e.includes("_"),r=je(t);return Ft(e,r)}},Gt=globalThis.crypto,me=Gt.subtle,Ln=e=>Gt.getRandomValues(e),Pn="0123456789abcdef",bt={encode:e=>{if(typeof e=="string"&&(e=new TextEncoder().encode(e)),e.byteLength===0)return"";const t=new Uint8Array(e);let r="";for(const n of t)r+=n.toString(16).padStart(2,"0");return r},decode:e=>{if(!e)return"";if(typeof e=="string"){if(e.length%2!==0)throw new Error("Invalid hexadecimal string");if(!new RegExp(`^[${Pn}]+$`).test(e))throw new Error("Invalid hexadecimal string");const t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.slice(r,r+2),16);return new TextDecoder().decode(t)}return new TextDecoder().decode(e)}},Zt=(e="SHA-256",t="none")=>{const r={importKey:async(n,i)=>me.importKey("raw",typeof n=="string"?new TextEncoder().encode(n):n,{name:"HMAC",hash:{name:e}},!1,[i]),sign:async(n,i)=>{typeof n=="string"&&(n=await r.importKey(n,"sign"));const o=await me.sign("HMAC",n,typeof i=="string"?new TextEncoder().encode(i):i);return t==="hex"?bt.encode(o):t==="base64"||t==="base64url"||t==="base64urlnopad"?Ne.encode(o,{padding:t!=="base64urlnopad"}):o},verify:async(n,i,o)=>(typeof n=="string"&&(n=await r.importKey(n,"verify")),t==="hex"&&(o=bt.decode(o)),(t==="base64"||t==="base64url"||t==="base64urlnopad")&&(o=await He.decode(o)),me.verify("HMAC",n,typeof o=="string"?new TextEncoder().encode(o):o,typeof i=="string"?new TextEncoder().encode(i):i))};return r},Ke=new Map,Cn=new TextEncoder,zn={decode:(e,t="utf-8")=>(Ke.has(t)||Ke.set(t,new TextDecoder(t)),Ke.get(t).decode(e)),encode:Cn.encode},ue=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));function Qt(e){function t(r,n){if(typeof n=="string"&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(n)){const o=new Date(n);if(!isNaN(o.getTime()))return o}return n}try{return JSON.parse(e,t)}catch{return null}}function Bn(e){const t=new Map;return e.split(", ").forEach(n=>{const i=n.split(";").map(l=>l.trim()),[o,...s]=i,[a,...c]=o.split("="),u=c.join("=");if(!a||u===void 0)return;const d={value:u};s.forEach(l=>{const[m,...h]=l.split("="),g=h.join("="),E=m.trim().toLowerCase();switch(E){case"max-age":d["max-age"]=g?parseInt(g.trim(),10):void 0;break;case"expires":d.expires=g?new Date(g.trim()):void 0;break;case"domain":d.domain=g?g.trim():void 0;break;case"path":d.path=g?g.trim():void 0;break;case"secure":d.secure=!0;break;case"httponly":d.httponly=!0;break;case"samesite":d.samesite=g?g.trim().toLowerCase():void 0;break;default:d[E]=g?g.trim():!0;break}}),t.set(a,d)}),t}async function Yt(e,t){if(e.context.options.session?.cookieCache?.enabled){const i={session:Object.entries(t.session).reduce((s,[a,c])=>{const u=e.context.options.session?.additionalFields?.[a];return(!u||u.returned!==!1)&&(s[a]=c),s},{}),user:t.user},o=Ne.encode(JSON.stringify({session:i,expiresAt:ue(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await Zt("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify({...i,expiresAt:ue(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime()}))}),{padding:!1});if(o.length>4093)throw new Te("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,o,e.context.authCookies.sessionData.options)}}async function re(e,t,r,n){const i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);r=r!==void 0?r:!!i;const o=e.context.authCookies.sessionToken.options,s=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.token,e.context.secret,{...o,maxAge:s,...n}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await Yt(e,t),e.context.setNewSession(t),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(t.session.token,JSON.stringify({user:t.user,session:t.session}),Math.floor((new Date(t.session.expiresAt).getTime()-Date.now())/1e3))}function Ae(e,t){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}var Mn={OK:200,CREATED:201,ACCEPTED:202,NO_CONTENT:204,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,"I'M_A_TEAPOT":418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511},f=class extends Error{constructor(e="INTERNAL_SERVER_ERROR",t=void 0,r={},n=typeof e=="number"?e:Mn[e]){super(t?.message),this.status=e,this.body=t,this.headers=r,this.statusCode=n,this.name="APIError",this.status=e,this.headers=r,this.statusCode=n,this.body=t?{code:t?.message?.toUpperCase().replace(/ /g,"_").replace(/[^A-Z0-9_]/g,""),...t}:void 0,this.stack=""}};function Xt(e){return e instanceof f||e?.name==="APIError"}function Vn(e){try{return e.includes("%")?decodeURIComponent(e):e}catch{return e}}function $n(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function et(e,t){if(e instanceof Response)return t?.headers instanceof Headers&&t.headers.forEach((i,o)=>{e.headers.set(o,i)}),e;if(e?._flag==="json"){const i=e.routerResponse;return i instanceof Response?i:et(e.body,{headers:e.headers,status:e.status})}if(Xt(e))return et(e.body,{status:e.statusCode,statusText:e.status.toString(),headers:t?.headers||e.headers});let r=e,n=new Headers(t?.headers);return e?typeof e=="string"?(r=e,n.set("Content-Type","text/plain")):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?(r=e,n.set("Content-Type","application/octet-stream")):e instanceof Blob?(r=e,n.set("Content-Type",e.type||"application/octet-stream")):e instanceof FormData?r=e:e instanceof URLSearchParams?(r=e,n.set("Content-Type","application/x-www-form-urlencoded")):e instanceof ReadableStream?(r=e,n.set("Content-Type","application/octet-stream")):$n(e)&&(r=JSON.stringify(e,(i,o)=>typeof o=="bigint"?o.toString():o),n.set("Content-Type","application/json")):(e===null&&(r=JSON.stringify(null)),n.set("content-type","application/json")),new Response(r,{...t,headers:n})}async function jn(e,t={}){let r={body:t.body,query:t.query};if(e.body){const n=await e.body["~standard"].validate(t.body);if(n.issues)return{data:null,error:_t(n.issues,"body")};r.body=n.value}if(e.query){const n=await e.query["~standard"].validate(t.query);if(n.issues)return{data:null,error:_t(n.issues,"query")};r.query=n.value}return e.requireHeaders&&!t.headers?{data:null,error:{message:"Headers is required"}}:e.requireRequest&&!t.request?{data:null,error:{message:"Request is required"}}:{data:r,error:null}}function _t(e,t){for(const r of e)r.message;return{message:`Invalid ${t} parameters`}}var dt={name:"HMAC",hash:"SHA-256"},er=async e=>{const t=typeof e=="string"?new TextEncoder().encode(e):e;return await me.importKey("raw",t,dt,!1,["sign","verify"])},Hn=async(e,t,r)=>{try{const n=atob(e),i=new Uint8Array(n.length);for(let o=0,s=n.length;o<s;o++)i[o]=n.charCodeAt(o);return await me.verify(dt,r,i,new TextEncoder().encode(t))}catch{return!1}},xn=async(e,t)=>{const r=await er(t),n=await me.sign(dt.name,r,new TextEncoder().encode(e));return btoa(String.fromCharCode(...new Uint8Array(n)))},qn=async(e,t)=>{const r=await xn(e,t);return e=`${e}.${r}`,e=encodeURIComponent(e),e},It=(e,t)=>{let r=e;if(t)if(t==="secure")r="__Secure-"+e;else if(t==="host")r="__Host-"+e;else return;return r};function Wn(e){if(typeof e!="string")throw new TypeError("argument str must be a string");const t=new Map;let r=0;for(;r<e.length;){const n=e.indexOf("=",r);if(n===-1)break;let i=e.indexOf(";",r);if(i===-1)i=e.length;else if(i<n){r=e.lastIndexOf(";",n-1)+1;continue}const o=e.slice(r,n).trim();if(!t.has(o)){let s=e.slice(n+1,i).trim();s.codePointAt(0)===34&&(s=s.slice(1,-1)),t.set(o,Vn(s))}r=i+1}return t}var tr=(e,t,r={})=>{let n;if(r?.prefix==="secure"?n=`${`__Secure-${e}`}=${t}`:r?.prefix==="host"?n=`${`__Host-${e}`}=${t}`:n=`${e}=${t}`,e.startsWith("__Secure-")&&!r.secure&&(r.secure=!0),e.startsWith("__Host-")&&(r.secure||(r.secure=!0),r.path!=="/"&&(r.path="/"),r.domain&&(r.domain=void 0)),r&&typeof r.maxAge=="number"&&r.maxAge>=0){if(r.maxAge>3456e4)throw new Error("Cookies Max-Age SHOULD NOT be greater than 400 days (34560000 seconds) in duration.");n+=`; Max-Age=${Math.floor(r.maxAge)}`}if(r.domain&&r.prefix!=="host"&&(n+=`; Domain=${r.domain}`),r.path&&(n+=`; Path=${r.path}`),r.expires){if(r.expires.getTime()-Date.now()>3456e7)throw new Error("Cookies Expires SHOULD NOT be greater than 400 days (34560000 seconds) in the future.");n+=`; Expires=${r.expires.toUTCString()}`}return r.httpOnly&&(n+="; HttpOnly"),r.secure&&(n+="; Secure"),r.sameSite&&(n+=`; SameSite=${r.sameSite.charAt(0).toUpperCase()+r.sameSite.slice(1)}`),r.partitioned&&(r.secure||(r.secure=!0),n+="; Partitioned"),n},Kn=(e,t,r)=>(t=encodeURIComponent(t),tr(e,t,r)),Jn=async(e,t,r,n)=>(t=await qn(t,r),tr(e,t,n)),rr=async(e,{options:t,path:r})=>{const n=new Headers,{data:i,error:o}=await jn(t,e);if(o)throw new f(400,{message:o.message,code:"VALIDATION_ERROR"});const s="headers"in e?e.headers instanceof Headers?e.headers:new Headers(e.headers):"request"in e&&e.request instanceof Request?e.request.headers:null,a=s?.get("cookie"),c=a?Wn(a):void 0,u={...e,body:i.body,query:i.query,path:e.path||r,context:"context"in e&&e.context?e.context:{},returned:void 0,headers:e?.headers,request:e?.request,params:"params"in e?e.params:void 0,method:e.method,setHeader:(d,l)=>{n.set(d,l)},getHeader:d=>s?s.get(d):null,getCookie:(d,l)=>{const m=It(d,l);return m&&c?.get(m)||null},getSignedCookie:async(d,l,m)=>{const h=It(d,m);if(!h)return null;const g=c?.get(h);if(!g)return null;const E=g.lastIndexOf(".");if(E<1)return null;const I=g.substring(0,E),v=g.substring(E+1);if(v.length!==44||!v.endsWith("="))return null;const _=await er(l);return await Hn(v,I,_)?I:!1},setCookie:(d,l,m)=>{const h=Kn(d,l,m);return n.append("set-cookie",h),h},setSignedCookie:async(d,l,m,h)=>{const g=await Jn(d,l,m,h);return n.append("set-cookie",g),g},redirect:d=>(n.set("location",d),new f("FOUND",void 0,n)),error:(d,l,m)=>new f(d,l,m),json:(d,l)=>e.asResponse?{body:l?.body||d,routerResponse:l,_flag:"json"}:d,responseHeaders:n};for(const d of t.use||[]){const l=await d({...u,returnHeaders:!0,asResponse:!1});l.response&&Object.assign(u.context,l.response),l.headers&&l.headers.forEach((m,h)=>{u.responseHeaders.set(h,m)})}return u};function ye(e,t){const r=async n=>{const i=n,o=typeof e=="function"?e:t,a=await rr(i,{options:typeof e=="function"?{}:e,path:"/"});if(!o)throw new Error("handler must be defined");const c=await o(a),u=a.responseHeaders;return i.returnHeaders?{headers:u,response:c}:c};return r.options=typeof e=="function"?{}:e,r}ye.create=e=>{function t(r,n){if(typeof r=="function")return ye({use:e?.use},r);if(!n)throw new Error("Middleware handler is required");return ye({...r,method:"*",use:[...e?.use||[],...r.use||[]]},n)}return t};var tt=(e,t,r)=>{const n=async(...i)=>{const o=i[0]||{},s=await rr(o,{options:t,path:e}),a=await r(s).catch(async u=>{if(Xt(u)){const d=t.onAPIError;if(d&&await d(u),o.asResponse)return u}throw u}),c=s.responseHeaders;return o.asResponse?et(a,{headers:c}):o.returnHeaders?{headers:c,response:a}:a};return n.options=t,n.path=e,n};tt.create=e=>(t,r,n)=>tt(t,{...r,use:[...r?.use||[],...e?.use||[]]},n);var ke;(function(e){e.assertEqual=i=>i;function t(i){}e.assertIs=t;function r(i){throw new Error}e.assertNever=r,e.arrayToEnum=i=>{const o={};for(const s of i)o[s]=s;return o},e.getValidEnumValues=i=>{const o=e.objectKeys(i).filter(a=>typeof i[i[a]]!="number"),s={};for(const a of o)s[a]=i[a];return e.objectValues(s)},e.objectValues=i=>e.objectKeys(i).map(function(o){return i[o]}),e.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const o=[];for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&o.push(s);return o},e.find=(i,o)=>{for(const s of i)if(o(s))return s},e.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&isFinite(i)&&Math.floor(i)===i;function n(i,o=" | "){return i.map(s=>typeof s=="string"?`'${s}'`:s).join(o)}e.joinValues=n,e.jsonStringifyReplacer=(i,o)=>typeof o=="bigint"?o.toString():o})(ke||(ke={}));var St;(function(e){e.mergeShapes=(t,r)=>({...t,...r})})(St||(St={}));ke.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]);ke.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);var Ot=class nr extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=t}format(t){const r=t||function(o){return o.message},n={_errors:[]},i=o=>{for(const s of o.issues)if(s.code==="invalid_union")s.unionErrors.map(i);else if(s.code==="invalid_return_type")i(s.returnTypeError);else if(s.code==="invalid_arguments")i(s.argumentsError);else if(s.path.length===0)n._errors.push(r(s));else{let a=n,c=0;for(;c<s.path.length;){const u=s.path[c];c===s.path.length-1?(a[u]=a[u]||{_errors:[]},a[u]._errors.push(r(s))):a[u]=a[u]||{_errors:[]},a=a[u],c++}}};return i(this),n}static assert(t){if(!(t instanceof nr))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ke.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=r=>r.message){const r={},n=[];for(const i of this.issues)i.path.length>0?(r[i.path[0]]=r[i.path[0]]||[],r[i.path[0]].push(t(i))):n.push(t(i));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}};Ot.create=e=>new Ot(e);var Rt;(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(Rt||(Rt={}));var vt;(function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"})(vt||(vt={}));function kt(e){switch(e){case"a-z":return"abcdefghijklmnopqrstuvwxyz";case"A-Z":return"ABCDEFGHIJKLMNOPQRSTUVWXYZ";case"0-9":return"0123456789";case"-_":return"-_";default:throw new Error(`Unsupported alphabet: ${e}`)}}function ir(...e){const t=e.map(kt).join("");if(t.length===0)throw new Error("No valid characters provided for random string generation.");const r=t.length;return(n,...i)=>{if(n<=0)throw new Error("Length must be a positive integer.");let o=t,s=r;i.length>0&&(o=i.map(kt).join(""),s=o.length);const a=Math.floor(256/s)*s,c=new Uint8Array(n*2),u=c.length;let d="",l=u,m;for(;d.length<n;)l>=u&&(Ln(c),l=0),m=c[l++],m<a&&(d+=o[m%s]);return d}}function Fn(e,t){return{digest:async r=>{const n=new TextEncoder,i=typeof r=="string"?n.encode(r):r;return await me.digest(e,i)}}}const G=new TextEncoder,ne=new TextDecoder;function or(...e){const t=e.reduce((i,{length:o})=>i+o,0),r=new Uint8Array(t);let n=0;for(const i of e)r.set(i,n),n+=i.length;return r}function Gn(e){if(Uint8Array.prototype.toBase64)return e.toBase64();const t=32768,r=[];for(let n=0;n<e.length;n+=t)r.push(String.fromCharCode.apply(null,e.subarray(n,n+t)));return btoa(r.join(""))}function Zn(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);const t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function he(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof e=="string"?e:ne.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=ne.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return Zn(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}function Je(e){let t=e;return typeof t=="string"&&(t=G.encode(t)),Uint8Array.prototype.toBase64?t.toBase64({alphabet:"base64url",omitPadding:!0}):Gn(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}class B extends Error{static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(t,r){super(t,r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class W extends B{static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(t,r,n="unspecified",i="unspecified"){super(t,{cause:{claim:n,reason:i,payload:r}}),this.claim=n,this.reason=i,this.payload=r}}class rt extends B{static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(t,r,n="unspecified",i="unspecified"){super(t,{cause:{claim:n,reason:i,payload:r}}),this.claim=n,this.reason=i,this.payload=r}}class Qn extends B{static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"}class te extends B{static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"}class R extends B{static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"}class J extends B{static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"}class sr extends B{static code="ERR_JWKS_INVALID";code="ERR_JWKS_INVALID"}class ar extends B{static code="ERR_JWKS_NO_MATCHING_KEY";code="ERR_JWKS_NO_MATCHING_KEY";constructor(t="no applicable key found in the JSON Web Key Set",r){super(t,r)}}class Yn extends B{[Symbol.asyncIterator];static code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";constructor(t="multiple matching keys found in the JSON Web Key Set",r){super(t,r)}}class Xn extends B{static code="ERR_JWKS_TIMEOUT";code="ERR_JWKS_TIMEOUT";constructor(t="request timed out",r){super(t,r)}}class ei extends B{static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(t="signature verification failed",r){super(t,r)}}function ee(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function Re(e,t){return e.name===t}function Fe(e){return parseInt(e.name.slice(4),10)}function ti(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function ri(e,t){if(t&&!e.usages.includes(t))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function ni(e,t,r){switch(t){case"HS256":case"HS384":case"HS512":{if(!Re(e.algorithm,"HMAC"))throw ee("HMAC");const n=parseInt(t.slice(2),10);if(Fe(e.algorithm.hash)!==n)throw ee(`SHA-${n}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!Re(e.algorithm,"RSASSA-PKCS1-v1_5"))throw ee("RSASSA-PKCS1-v1_5");const n=parseInt(t.slice(2),10);if(Fe(e.algorithm.hash)!==n)throw ee(`SHA-${n}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!Re(e.algorithm,"RSA-PSS"))throw ee("RSA-PSS");const n=parseInt(t.slice(2),10);if(Fe(e.algorithm.hash)!==n)throw ee(`SHA-${n}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":{if(!Re(e.algorithm,"Ed25519"))throw ee("Ed25519");break}case"ES256":case"ES384":case"ES512":{if(!Re(e.algorithm,"ECDSA"))throw ee("ECDSA");const n=ti(t);if(e.algorithm.namedCurve!==n)throw ee(n,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}ri(e,r)}function cr(e,t,...r){if(r=r.filter(Boolean),r.length>2){const n=r.pop();e+=`one of type ${r.join(", ")}, or ${n}.`}else r.length===2?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const ii=(e,...t)=>cr("Key must be ",e,...t);function dr(e,t,...r){return cr(`Key for the ${e} algorithm must be `,t,...r)}function ur(e){return e?.[Symbol.toStringTag]==="CryptoKey"}function lr(e){return e?.[Symbol.toStringTag]==="KeyObject"}const fr=e=>ur(e)||lr(e),pr=(...e)=>{const t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let r;for(const n of t){const i=Object.keys(n);if(!r||r.size===0){r=new Set(i);continue}for(const o of i){if(r.has(o))return!1;r.add(o)}}return!0};function oi(e){return typeof e=="object"&&e!==null}const x=e=>{if(!oi(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t},mr=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if(typeof r!="number"||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function si(e){let t,r;switch(e.kty){case"RSA":{switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new te('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}const hr=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=si(e),n={...e};return delete n.alg,delete n.use,crypto.subtle.importKey("jwk",n,t,e.ext??!e.d,e.key_ops??r)};async function gr(e,t,r){if(!x(e))throw new TypeError("JWK must be an object");let n;switch(t??=e.alg,n??=e.ext,e.kty){case"oct":if(typeof e.k!="string"||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return he(e.k);case"RSA":if("oth"in e&&e.oth!==void 0)throw new te('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return hr({...e,alg:t,ext:n});default:throw new te('Unsupported "kty" (Key Type) Parameter value')}}const wr=(e,t,r,n,i)=>{if(i.crit!==void 0&&n?.crit===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||n.crit===void 0)return new Set;if(!Array.isArray(n.crit)||n.crit.length===0||n.crit.some(s=>typeof s!="string"||s.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let o;r!==void 0?o=new Map([...Object.entries(r),...t.entries()]):o=t;for(const s of n.crit){if(!o.has(s))throw new te(`Extension Header Parameter "${s}" is not recognized`);if(i[s]===void 0)throw new e(`Extension Header Parameter "${s}" is missing`);if(o.get(s)&&n[s]===void 0)throw new e(`Extension Header Parameter "${s}" MUST be integrity protected`)}return new Set(n.crit)},ai=(e,t)=>{if(t!==void 0&&(!Array.isArray(t)||t.some(r=>typeof r!="string")))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};function ut(e){return x(e)&&typeof e.kty=="string"}function ci(e){return e.kty!=="oct"&&typeof e.d=="string"}function di(e){return e.kty!=="oct"&&typeof e.d>"u"}function ui(e){return e.kty==="oct"&&typeof e.k=="string"}let Ee;const Ut=async(e,t,r,n=!1)=>{Ee||=new WeakMap;let i=Ee.get(e);if(i?.[r])return i[r];const o=await hr({...t,alg:r});return n&&Object.freeze(e),i?i[r]=o:Ee.set(e,{[r]:o}),o},li=(e,t)=>{Ee||=new WeakMap;let r=Ee.get(e);if(r?.[t])return r[t];const n=e.type==="public",i=!!n;let o;if(e.asymmetricKeyType==="x25519"){switch(t){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}o=e.toCryptoKey(e.asymmetricKeyType,i,n?[]:["deriveBits"])}if(e.asymmetricKeyType==="ed25519"){if(t!=="EdDSA"&&t!=="Ed25519")throw new TypeError("given KeyObject instance cannot be used for this algorithm");o=e.toCryptoKey(e.asymmetricKeyType,i,[n?"verify":"sign"])}if(e.asymmetricKeyType==="rsa"){let s;switch(t){case"RSA-OAEP":s="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":s="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":s="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":s="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(t.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:s},i,n?["encrypt"]:["decrypt"]);o=e.toCryptoKey({name:t.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:s},i,[n?"verify":"sign"])}if(e.asymmetricKeyType==="ec"){const a=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(e.asymmetricKeyDetails?.namedCurve);if(!a)throw new TypeError("given KeyObject instance cannot be used for this algorithm");t==="ES256"&&a==="P-256"&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:a},i,[n?"verify":"sign"])),t==="ES384"&&a==="P-384"&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:a},i,[n?"verify":"sign"])),t==="ES512"&&a==="P-521"&&(o=e.toCryptoKey({name:"ECDSA",namedCurve:a},i,[n?"verify":"sign"])),t.startsWith("ECDH-ES")&&(o=e.toCryptoKey({name:"ECDH",namedCurve:a},i,n?[]:["deriveBits"]))}if(!o)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return r?r[t]=o:Ee.set(e,{[t]:o}),o},yr=async(e,t)=>{if(e instanceof Uint8Array||ur(e))return e;if(lr(e)){if(e.type==="secret")return e.export();if("toCryptoKey"in e&&typeof e.toCryptoKey=="function")try{return li(e,t)}catch(n){if(n instanceof TypeError)throw n}let r=e.export({format:"jwk"});return Ut(e,r,t)}if(ut(e))return e.k?he(e.k):Ut(e,e,t,!0);throw new Error("unreachable")},we=e=>e?.[Symbol.toStringTag],nt=(e,t,r)=>{if(t.use!==void 0){let n;switch(r){case"sign":case"verify":n="sig";break;case"encrypt":case"decrypt":n="enc";break}if(t.use!==n)throw new TypeError(`Invalid key for this operation, its "use" must be "${n}" when present`)}if(t.alg!==void 0&&t.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let n;switch(!0){case(r==="sign"||r==="verify"):case e==="dir":case e.includes("CBC-HS"):n=r;break;case e.startsWith("PBES2"):n="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):!e.includes("GCM")&&e.endsWith("KW")?n=r==="encrypt"?"wrapKey":"unwrapKey":n=r;break;case(r==="encrypt"&&e.startsWith("RSA")):n="wrapKey";break;case r==="decrypt":n=e.startsWith("RSA")?"unwrapKey":"deriveBits";break}if(n&&t.key_ops?.includes?.(n)===!1)throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${n}" when present`)}return!0},fi=(e,t,r)=>{if(!(t instanceof Uint8Array)){if(ut(t)){if(ui(t)&&nt(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!fr(t))throw new TypeError(dr(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if(t.type!=="secret")throw new TypeError(`${we(t)} instances for symmetric algorithms must be of type "secret"`)}},pi=(e,t,r)=>{if(ut(t))switch(r){case"decrypt":case"sign":if(ci(t)&&nt(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(di(t)&&nt(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!fr(t))throw new TypeError(dr(e,t,"CryptoKey","KeyObject","JSON Web Key"));if(t.type==="secret")throw new TypeError(`${we(t)} instances for asymmetric algorithms must not be of type "secret"`);if(t.type==="public")switch(r){case"sign":throw new TypeError(`${we(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${we(t)} instances for asymmetric algorithm decryption must be of type "private"`)}if(t.type==="private")switch(r){case"verify":throw new TypeError(`${we(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${we(t)} instances for asymmetric algorithm encryption must be of type "public"`)}},Er=(e,t,r)=>{e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?fi(e,t,r):pi(e,t,r)},Tr=(e,t)=>{const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};default:throw new te(`alg ${e} is not supported either by JOSE or your javascript runtime`)}},Ar=async(e,t,r)=>{if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(ii(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}return ni(t,e,r),t},mi=async(e,t,r,n)=>{const i=await Ar(e,t,"verify");mr(e,i);const o=Tr(e,i.algorithm);try{return await crypto.subtle.verify(o,i,r,n)}catch{return!1}};async function hi(e,t,r){if(!x(e))throw new R("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new R('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new R("JWS Protected Header incorrect type");if(e.payload===void 0)throw new R("JWS Payload missing");if(typeof e.signature!="string")throw new R("JWS Signature missing or incorrect type");if(e.header!==void 0&&!x(e.header))throw new R("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const I=he(e.protected);n=JSON.parse(ne.decode(I))}catch{throw new R("JWS Protected Header is invalid")}if(!pr(n,e.header))throw new R("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const i={...n,...e.header},o=wr(R,new Map([["b64",!0]]),r?.crit,n,i);let s=!0;if(o.has("b64")&&(s=n.b64,typeof s!="boolean"))throw new R('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=i;if(typeof a!="string"||!a)throw new R('JWS "alg" (Algorithm) Header Parameter missing or invalid');const c=r&&ai("algorithms",r.algorithms);if(c&&!c.has(a))throw new Qn('"alg" (Algorithm) Header Parameter value not allowed');if(s){if(typeof e.payload!="string")throw new R("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new R("JWS Payload must be a string or an Uint8Array instance");let u=!1;typeof t=="function"&&(t=await t(n,e),u=!0),Er(a,t,"verify");const d=or(G.encode(e.protected??""),G.encode("."),typeof e.payload=="string"?G.encode(e.payload):e.payload);let l;try{l=he(e.signature)}catch{throw new R("Failed to base64url decode the signature")}const m=await yr(t,a);if(!await mi(a,m,l,d))throw new ei;let g;if(s)try{g=he(e.payload)}catch{throw new R("Failed to base64url decode the payload")}else typeof e.payload=="string"?g=G.encode(e.payload):g=e.payload;const E={payload:g};return e.protected!==void 0&&(E.protectedHeader=n),e.header!==void 0&&(E.unprotectedHeader=e.header),u?{...E,key:m}:E}async function gi(e,t,r){if(e instanceof Uint8Array&&(e=ne.decode(e)),typeof e!="string")throw new R("Compact JWS must be a string or Uint8Array");const{0:n,1:i,2:o,length:s}=e.split(".");if(s!==3)throw new R("Invalid Compact JWS");const a=await hi({payload:i,protected:n,signature:o},t,r),c={payload:a.payload,protectedHeader:a.protectedHeader};return typeof t=="function"?{...c,key:a.key}:c}const de=e=>Math.floor(e.getTime()/1e3),br=60,_r=br*60,lt=_r*24,wi=lt*7,yi=lt*365.25,Ei=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,ve=e=>{const t=Ei.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]),n=t[3].toLowerCase();let i;switch(n){case"sec":case"secs":case"second":case"seconds":case"s":i=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":i=Math.round(r*br);break;case"hour":case"hours":case"hr":case"hrs":case"h":i=Math.round(r*_r);break;case"day":case"days":case"d":i=Math.round(r*lt);break;case"week":case"weeks":case"w":i=Math.round(r*wi);break;default:i=Math.round(r*yi);break}return t[1]==="-"||t[4]==="ago"?-i:i};function fe(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}const Nt=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`,Ti=(e,t)=>typeof e=="string"?t.includes(e):Array.isArray(e)?t.some(Set.prototype.has.bind(new Set(e))):!1;function Ai(e,t,r={}){let n;try{n=JSON.parse(ne.decode(t))}catch{}if(!x(n))throw new J("JWT Claims Set must be a top-level JSON object");const{typ:i}=r;if(i&&(typeof e.typ!="string"||Nt(e.typ)!==Nt(i)))throw new W('unexpected "typ" JWT header value',n,"typ","check_failed");const{requiredClaims:o=[],issuer:s,subject:a,audience:c,maxTokenAge:u}=r,d=[...o];u!==void 0&&d.push("iat"),c!==void 0&&d.push("aud"),a!==void 0&&d.push("sub"),s!==void 0&&d.push("iss");for(const g of new Set(d.reverse()))if(!(g in n))throw new W(`missing required "${g}" claim`,n,g,"missing");if(s&&!(Array.isArray(s)?s:[s]).includes(n.iss))throw new W('unexpected "iss" claim value',n,"iss","check_failed");if(a&&n.sub!==a)throw new W('unexpected "sub" claim value',n,"sub","check_failed");if(c&&!Ti(n.aud,typeof c=="string"?[c]:c))throw new W('unexpected "aud" claim value',n,"aud","check_failed");let l;switch(typeof r.clockTolerance){case"string":l=ve(r.clockTolerance);break;case"number":l=r.clockTolerance;break;case"undefined":l=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:m}=r,h=de(m||new Date);if((n.iat!==void 0||u)&&typeof n.iat!="number")throw new W('"iat" claim must be a number',n,"iat","invalid");if(n.nbf!==void 0){if(typeof n.nbf!="number")throw new W('"nbf" claim must be a number',n,"nbf","invalid");if(n.nbf>h+l)throw new W('"nbf" claim timestamp check failed',n,"nbf","check_failed")}if(n.exp!==void 0){if(typeof n.exp!="number")throw new W('"exp" claim must be a number',n,"exp","invalid");if(n.exp<=h-l)throw new rt('"exp" claim timestamp check failed',n,"exp","check_failed")}if(u){const g=h-n.iat,E=typeof u=="number"?u:ve(u);if(g-l>E)throw new rt('"iat" claim timestamp check failed (too far in the past)',n,"iat","check_failed");if(g<0-l)throw new W('"iat" claim timestamp check failed (it should be in the past)',n,"iat","check_failed")}return n}class bi{#e;constructor(t){if(!x(t))throw new TypeError("JWT Claims Set MUST be an object");this.#e=structuredClone(t)}data(){return G.encode(JSON.stringify(this.#e))}get iss(){return this.#e.iss}set iss(t){this.#e.iss=t}get sub(){return this.#e.sub}set sub(t){this.#e.sub=t}get aud(){return this.#e.aud}set aud(t){this.#e.aud=t}set jti(t){this.#e.jti=t}set nbf(t){typeof t=="number"?this.#e.nbf=fe("setNotBefore",t):t instanceof Date?this.#e.nbf=fe("setNotBefore",de(t)):this.#e.nbf=de(new Date)+ve(t)}set exp(t){typeof t=="number"?this.#e.exp=fe("setExpirationTime",t):t instanceof Date?this.#e.exp=fe("setExpirationTime",de(t)):this.#e.exp=de(new Date)+ve(t)}set iat(t){typeof t>"u"?this.#e.iat=de(new Date):t instanceof Date?this.#e.iat=fe("setIssuedAt",de(t)):typeof t=="string"?this.#e.iat=fe("setIssuedAt",de(new Date)+ve(t)):this.#e.iat=fe("setIssuedAt",t)}}async function ft(e,t,r){const n=await gi(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&n.protectedHeader.b64===!1)throw new J("JWTs MUST NOT use unencoded payload");const o={payload:Ai(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return typeof t=="function"?{...o,key:n.key}:o}const _i=async(e,t,r)=>{const n=await Ar(e,t,"sign");mr(e,n);const i=await crypto.subtle.sign(Tr(e,n.algorithm),n,r);return new Uint8Array(i)};class Ii{#e;#t;#r;constructor(t){if(!(t instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this.#e=t}setProtectedHeader(t){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=t,this}setUnprotectedHeader(t){if(this.#r)throw new TypeError("setUnprotectedHeader can only be called once");return this.#r=t,this}async sign(t,r){if(!this.#t&&!this.#r)throw new R("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!pr(this.#t,this.#r))throw new R("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const n={...this.#t,...this.#r},i=wr(R,new Map([["b64",!0]]),r?.crit,this.#t,n);let o=!0;if(i.has("b64")&&(o=this.#t.b64,typeof o!="boolean"))throw new R('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:s}=n;if(typeof s!="string"||!s)throw new R('JWS "alg" (Algorithm) Header Parameter missing or invalid');Er(s,t,"sign");let a=this.#e;o&&(a=G.encode(Je(a)));let c;this.#t?c=G.encode(Je(JSON.stringify(this.#t))):c=G.encode("");const u=or(c,G.encode("."),a),d=await yr(t,s),l=await _i(s,d,u),m={signature:Je(l),payload:""};return o&&(m.payload=ne.decode(a)),this.#r&&(m.header=this.#r),this.#t&&(m.protected=ne.decode(c)),m}}class Si{#e;constructor(t){this.#e=new Ii(t)}setProtectedHeader(t){return this.#e.setProtectedHeader(t),this}async sign(t,r){const n=await this.#e.sign(t,r);if(n.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${n.protected}.${n.payload}.${n.signature}`}}class Oi{#e;#t;constructor(t={}){this.#t=new bi(t)}setIssuer(t){return this.#t.iss=t,this}setSubject(t){return this.#t.sub=t,this}setAudience(t){return this.#t.aud=t,this}setJti(t){return this.#t.jti=t,this}setNotBefore(t){return this.#t.nbf=t,this}setExpirationTime(t){return this.#t.exp=t,this}setIssuedAt(t){return this.#t.iat=t,this}setProtectedHeader(t){return this.#e=t,this}async sign(t,r){const n=new Si(this.#t.data());if(n.setProtectedHeader(this.#e),Array.isArray(this.#e?.crit)&&this.#e.crit.includes("b64")&&this.#e.b64===!1)throw new J("JWTs MUST NOT use unencoded payload");return n.sign(t,r)}}function Ri(e){switch(typeof e=="string"&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new te('Unsupported "alg" value for a JSON Web Key Set')}}function vi(e){return e&&typeof e=="object"&&Array.isArray(e.keys)&&e.keys.every(ki)}function ki(e){return x(e)}class Ui{#e;#t=new WeakMap;constructor(t){if(!vi(t))throw new sr("JSON Web Key Set malformed");this.#e=structuredClone(t)}jwks(){return this.#e}async getKey(t,r){const{alg:n,kid:i}={...t,...r?.header},o=Ri(n),s=this.#e.keys.filter(u=>{let d=o===u.kty;if(d&&typeof i=="string"&&(d=i===u.kid),d&&typeof u.alg=="string"&&(d=n===u.alg),d&&typeof u.use=="string"&&(d=u.use==="sig"),d&&Array.isArray(u.key_ops)&&(d=u.key_ops.includes("verify")),d)switch(n){case"ES256":d=u.crv==="P-256";break;case"ES384":d=u.crv==="P-384";break;case"ES512":d=u.crv==="P-521";break;case"Ed25519":case"EdDSA":d=u.crv==="Ed25519";break}return d}),{0:a,length:c}=s;if(c===0)throw new ar;if(c!==1){const u=new Yn,d=this.#t;throw u[Symbol.asyncIterator]=async function*(){for(const l of s)try{yield await Dt(d,l,n)}catch{}},u}return Dt(this.#t,a,n)}}async function Dt(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(n[r]===void 0){const i=await gr({...t,ext:!0},r);if(i instanceof Uint8Array||i.type!=="public")throw new sr("JSON Web Key Set members must be public keys");n[r]=i}return n[r]}function Lt(e){const t=new Ui(e),r=async(n,i)=>t.getKey(n,i);return Object.defineProperties(r,{jwks:{value:()=>structuredClone(t.jwks()),enumerable:!1,configurable:!1,writable:!1}}),r}function Ni(){return typeof WebSocketPair<"u"||typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"||typeof EdgeRuntime<"u"&&EdgeRuntime==="vercel"}let it;(typeof navigator>"u"||!navigator.userAgent?.startsWith?.("Mozilla/5.0 "))&&(it="jose/v6.0.11");const Di=Symbol();async function Li(e,t,r,n=fetch){const i=await n(e,{method:"GET",signal:r,redirect:"manual",headers:t}).catch(o=>{throw o.name==="TimeoutError"?new Xn:o});if(i.status!==200)throw new B("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await i.json()}catch{throw new B("Failed to parse the JSON Web Key Set HTTP response as JSON")}}const Ge=Symbol();function Pi(e,t){return!(typeof e!="object"||e===null||!("uat"in e)||typeof e.uat!="number"||Date.now()-e.uat>=t||!("jwks"in e)||!x(e.jwks)||!Array.isArray(e.jwks.keys)||!Array.prototype.every.call(e.jwks.keys,x))}class Ci{#e;#t;#r;#c;#o;#n;#i;#d;#s;#a;constructor(t,r){if(!(t instanceof URL))throw new TypeError("url must be an instance of URL");this.#e=new URL(t.href),this.#t=typeof r?.timeoutDuration=="number"?r?.timeoutDuration:5e3,this.#r=typeof r?.cooldownDuration=="number"?r?.cooldownDuration:3e4,this.#c=typeof r?.cacheMaxAge=="number"?r?.cacheMaxAge:6e5,this.#i=new Headers(r?.headers),it&&!this.#i.has("User-Agent")&&this.#i.set("User-Agent",it),this.#i.has("accept")||(this.#i.set("accept","application/json"),this.#i.append("accept","application/jwk-set+json")),this.#d=r?.[Di],r?.[Ge]!==void 0&&(this.#a=r?.[Ge],Pi(r?.[Ge],this.#c)&&(this.#o=this.#a.uat,this.#s=Lt(this.#a.jwks)))}pendingFetch(){return!!this.#n}coolingDown(){return typeof this.#o=="number"?Date.now()<this.#o+this.#r:!1}fresh(){return typeof this.#o=="number"?Date.now()<this.#o+this.#c:!1}jwks(){return this.#s?.jwks()}async getKey(t,r){(!this.#s||!this.fresh())&&await this.reload();try{return await this.#s(t,r)}catch(n){if(n instanceof ar&&this.coolingDown()===!1)return await this.reload(),this.#s(t,r);throw n}}async reload(){this.#n&&Ni()&&(this.#n=void 0),this.#n||=Li(this.#e.href,this.#i,AbortSignal.timeout(this.#t),this.#d).then(t=>{this.#s=Lt(t),this.#a&&(this.#a.uat=Date.now(),this.#a.jwks=t),this.#o=Date.now(),this.#n=void 0}).catch(t=>{throw this.#n=void 0,t}),await this.#n}}function zi(e,t){const r=new Ci(e,t),n=async(i,o)=>r.getKey(i,o);return Object.defineProperties(n,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>r.pendingFetch(),enumerable:!0,configurable:!1},jwks:{value:()=>r.jwks(),enumerable:!0,configurable:!1,writable:!1}}),n}function Bi(e){let t;if(typeof e=="string"){const r=e.split(".");(r.length===3||r.length===5)&&([t]=r)}else if(typeof e=="object"&&e)if("protected"in e)t=e.protected;else throw new TypeError("Token does not contain a Protected Header");try{if(typeof t!="string"||!t)throw new Error;const r=JSON.parse(ne.decode(he(t)));if(!x(r))throw new Error;return r}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}function De(e){if(typeof e!="string")throw new J("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(r===5)throw new J("Only JWTs using Compact JWS serialization can be decoded");if(r!==3)throw new J("Invalid JWT");if(!t)throw new J("JWTs must contain a payload");let n;try{n=he(t)}catch{throw new J("Failed to base64url decode the payload")}let i;try{i=JSON.parse(ne.decode(n))}catch{throw new J("Failed to parse the decoded payload as JSON")}if(!x(i))throw new J("Invalid JWT Claims Set");return i}const ot=ir("a-z","0-9","A-Z","-_");async function Ir(e,t){const r=e.body?.callbackURL||e.context.options.baseURL;if(!r)throw new f("BAD_REQUEST",{message:"callbackURL is required"});const n=ot(128),i=ot(32),o=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+10*60*1e3,requestSignUp:e.body?.requestSignUp}),s=new Date;s.setMinutes(s.getMinutes()+10);const a=await e.context.internalAdapter.createVerificationValue({value:o,identifier:i,expiresAt:s},e);if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new f("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:n}}async function Mi(e){const t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r){e.context.logger.error("State Mismatch. Verification not found",{state:t});const i=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${i}?error=please_restart_the_process`)}const n=w({callbackURL:p(),codeVerifier:p(),errorURL:p().optional(),newUserURL:p().optional(),expiresAt:zt(),link:w({email:p(),userId:Ue.string()}).optional(),requestSignUp:Z().optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now()){await e.context.internalAdapter.deleteVerificationValue(r.id);const i=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${i}?error=please_restart_the_process`)}return await e.context.internalAdapter.deleteVerificationValue(r.id),n}const st=["info","success","warn","error","debug"];function Vi(e,t){return st.indexOf(t)<=st.indexOf(e)}const F={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",fg:{red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m"}},$i={info:F.fg.blue,success:F.fg.green,warn:F.fg.yellow,error:F.fg.red,debug:F.fg.magenta},ji=(e,t)=>{const r=new Date().toISOString();return`${F.dim}${r}${F.reset} ${$i[e]}${e.toUpperCase()}${F.reset} ${F.bright}[Better Auth]:${F.reset} ${t}`},Hi=e=>{const t="error",r=(n,i,o=[])=>{if(!Vi(t,n))return;const s=ji(n,i);{n==="error"?console.error(s,...o):n==="warn"?console.warn(s,...o):console.log(s,...o);return}};return Object.fromEntries(st.map(n=>[n,(...[i,...o])=>r(n,i,o)]))},pe=Hi();async function Sr(e){const t=await Fn("SHA-256").digest(e);return Ne.encode(new Uint8Array(t),{padding:!1})}function Or(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?ue(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function z({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:i,scopes:o,claims:s,redirectURI:a,duration:c,prompt:u,accessType:d,responseType:l,display:m,loginHint:h,hd:g,responseMode:E,additionalParams:I,scopeJoiner:v}){const _=new URL(r);if(_.searchParams.set("response_type",l||"code"),_.searchParams.set("client_id",t.clientId),_.searchParams.set("state",n),_.searchParams.set("scope",o.join(v||" ")),_.searchParams.set("redirect_uri",t.redirectURI||a),c&&_.searchParams.set("duration",c),m&&_.searchParams.set("display",m),h&&_.searchParams.set("login_hint",h),u&&_.searchParams.set("prompt",u),g&&_.searchParams.set("hd",g),d&&_.searchParams.set("access_type",d),E&&_.searchParams.set("response_mode",E),i){const P=await Sr(i);_.searchParams.set("code_challenge_method","S256"),_.searchParams.set("code_challenge",P)}if(s){const P=s.reduce((S,Q)=>(S[Q]=null,S),{});_.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...P}}))}return I&&Object.entries(I).forEach(([P,S])=>{_.searchParams.set(P,S)}),_}async function U({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:i,authentication:o,deviceId:s,headers:a}){const c=new URLSearchParams,u={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth",...a};if(c.set("grant_type","authorization_code"),c.set("code",e),t&&c.set("code_verifier",t),n.clientKey&&c.set("client_key",n.clientKey),s&&c.set("device_id",s),c.set("redirect_uri",n.redirectURI||r),o==="basic"){const h=Ne.encode(`${n.clientId}:${n.clientSecret}`);u.authorization=`Basic ${h}`}else c.set("client_id",n.clientId),c.set("client_secret",n.clientSecret);const{data:d,error:l}=await O(i,{method:"POST",body:c,headers:u});if(l)throw l;return Or(d)}async function N({refreshToken:e,options:t,tokenEndpoint:r,authentication:n,extraParams:i,grantType:o="refresh_token"}){const s=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json"};if(s.set("grant_type",o),s.set("refresh_token",e),n==="basic"){const l=Ne.encode(`${t.clientId}:${t.clientSecret}`);a.authorization=`Basic ${l}`}else s.set("client_id",t.clientId),s.set("client_secret",t.clientSecret);if(i)for(const[l,m]of Object.entries(i))s.set(l,m);const{data:c,error:u}=await O(r,{method:"POST",body:s,headers:a});if(u)throw u;const d={accessToken:c.access_token,refreshToken:c.refresh_token,tokenType:c.token_type,scopes:c.scope?.split(" "),idToken:c.id_token};if(c.expires_in){const l=new Date;d.accessTokenExpiresAt=new Date(l.getTime()+c.expires_in*1e3)}return d}const xi=e=>{const t="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",async createAuthorizationURL({state:r,scopes:n,redirectURI:i}){const o=e.disableDefaultScope?[]:["email","name"];return e.scope&&o.push(...e.scope),n&&o.push(...n),await z({id:"apple",options:e,authorizationEndpoint:"https://appleid.apple.com/auth/authorize",scopes:o,state:r,redirectURI:i,responseMode:"form_post",responseType:"code id_token"})},validateAuthorizationCode:async({code:r,codeVerifier:n,redirectURI:i})=>U({code:r,codeVerifier:n,redirectURI:i,options:e,tokenEndpoint:t}),async verifyIdToken(r,n){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,n);const i=Bi(r),{kid:o,alg:s}=i;if(!o||!s)return!1;const a=await qi(o),{payload:c}=await ft(r,a,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.appBundleIdentifier||e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(u=>{c[u]!==void 0&&(c[u]=!!c[u])}),n&&c.nonce!==n?!1:!!c},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>N({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://appleid.apple.com/auth/token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);if(!r.idToken)return null;const n=De(r.idToken);if(!n)return null;const i=r.user?`${r.user.name?.firstName} ${r.user.name?.lastName}`:n.name||n.email,o=typeof n.email_verified=="boolean"?n.email_verified:n.email_verified==="true",s=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:i,emailVerified:o,email:n.email,...s},data:n}},options:e}},qi=async e=>{const t="https://appleid.apple.com",r="/auth/keys",{data:n}=await O(`${t}${r}`);if(!n?.keys)throw new f("BAD_REQUEST",{message:"Keys not found"});const i=n.keys.find(o=>o.kid===e);if(!i)throw new Error(`JWK with kid ${e} not found`);return await gr(i,i.alg)},Wi=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["identify","email"];return r&&i.push(...r),e.scope&&i.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"none"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>U({code:t,redirectURI:r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;if(r.avatar===null){const o=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${o}.png`}else{const o=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${o}`}const i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.global_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...i},data:r}},options:e}),Ki=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:n,loginHint:i}){const o=e.disableDefaultScope?[]:["email","public_profile"];return e.scope&&o.push(...e.scope),r&&o.push(...r),await z({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:o,state:t,redirectURI:n,loginHint:i,additionalParams:e.configId?{config_id:e.configId}:{}})},validateAuthorizationCode:async({code:t,redirectURI:r})=>U({code:t,redirectURI:r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);if(t.split(".").length)try{const{payload:n}=await ft(t,zi(new URL("https://www.facebook.com/.well-known/oauth/openid/jwks")),{algorithms:["RS256"],audience:e.clientId,issuer:"https://www.facebook.com"});return r&&n.nonce!==r?!1:!!n}catch{return!1}return!0},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://graph.facebook.com/v18.0/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken){const s=De(t.idToken),a={id:s.sub,name:s.name,email:s.email,picture:{data:{url:s.picture,height:100,width:100,is_silhouette:!1}}},c=await e.mapProfileToUser?.({...a,email_verified:!0});return{user:{...a,emailVerified:!0,...c},data:s}}const r=["id","name","email","picture",...e?.fields||[]],{data:n,error:i}=await O("https://graph.facebook.com/me?fields="+r.join(","),{auth:{type:"Bearer",token:t.accessToken}});if(i)return null;const o=await e.mapProfileToUser?.(n);return{user:{id:n.id,name:n.name,email:n.email,image:n.picture.data.url,emailVerified:n.email_verified,...o},data:n}},options:e}),Ji=e=>{const t="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:n,loginHint:i,redirectURI:o}){const s=e.disableDefaultScope?[]:["read:user","user:email"];return e.scope&&s.push(...e.scope),n&&s.push(...n),z({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:r,redirectURI:o,loginHint:i,prompt:e.prompt})},validateAuthorizationCode:async({code:r,redirectURI:n})=>U({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>N({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://github.com/login/oauth/access_token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:i}=await O("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(i)return null;const{data:o}=await O("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});!n.email&&o&&(n.email=(o.find(c=>c.primary)??o[0])?.email);const s=o?.find(c=>c.email===n.email)?.verified??!1,a=await e.mapProfileToUser?.(n);return{user:{id:n.id.toString(),name:n.name||n.login,email:n.email,image:n.avatar_url,emailVerified:s,...a},data:n}},options:e}},Fi=e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i,loginHint:o,display:s}){if(!e.clientId||!e.clientSecret)throw pe.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new Te("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new Te("codeVerifier is required for Google");const a=e.disableDefaultScope?[]:["email","profile","openid"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await z({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:a,state:t,codeVerifier:n,redirectURI:i,prompt:e.prompt,accessType:e.accessType,display:s||e.display,loginHint:o,hd:e.hd,additionalParams:{include_granted_scopes:"true"}})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>U({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);const n=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`,{data:i}=await O(n);return i?i.aud===e.clientId&&(i.iss==="https://accounts.google.com"||i.iss==="accounts.google.com"):!1},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;const r=De(t.idToken),n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...n},data:r}},options:e}),Gi=e=>({id:"huggingface",name:"Hugging Face",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const o=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&o.push(...e.scope),r&&o.push(...r),z({id:"huggingface",options:e,authorizationEndpoint:"https://huggingface.co/oauth/authorize",scopes:o,state:t,codeVerifier:n,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>U({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://huggingface.co/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://huggingface.co/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://huggingface.co/oauth/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...i},data:r}},options:e}),Zi=e=>{const t=e.tenantId||"common",r=`https://login.microsoftonline.com/${t}/oauth2/v2.0/authorize`,n=`https://login.microsoftonline.com/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(i){const o=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&o.push(...e.scope),i.scopes&&o.push(...i.scopes),z({id:"microsoft",options:e,authorizationEndpoint:r,state:i.state,codeVerifier:i.codeVerifier,scopes:o,redirectURI:i.redirectURI,prompt:e.prompt})},validateAuthorizationCode({code:i,codeVerifier:o,redirectURI:s}){return U({code:i,codeVerifier:o,redirectURI:s,options:e,tokenEndpoint:n})},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);if(!i.idToken)return null;const o=De(i.idToken),s=e.profilePhotoSize||48;await O(`https://graph.microsoft.com/v1.0/me/photos/${s}x${s}/$value`,{headers:{Authorization:`Bearer ${i.accessToken}`},async onResponse(c){if(!(e.disableProfilePhoto||!c.response.ok))try{const d=await c.response.clone().arrayBuffer(),l=He.encode(d);o.picture=`data:image/jpeg;base64, ${l}`}catch(u){pe.error(u&&typeof u=="object"&&"name"in u?u.name:"",u)}}});const a=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.name,email:o.email,image:o.picture,emailVerified:!0,...a},data:o}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async i=>{const o=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&o.push(...e.scope),N({refreshToken:i,options:{clientId:e.clientId,clientSecret:e.clientSecret},extraParams:{scope:o.join(" ")},tokenEndpoint:n})},options:e}},Qi=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const o=e.disableDefaultScope?[]:["user-read-email"];return e.scope&&o.push(...e.scope),r&&o.push(...r),z({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:o,state:t,codeVerifier:n,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>U({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...i},data:r}},options:e}),Yi=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["user:read:email","openid"];return e.scope&&i.push(...e.scope),r&&i.push(...r),z({id:"twitch",redirectURI:n,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:i,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>U({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const r=t.idToken;if(!r)return pe.error("No idToken found in token"),null;const n=De(r),i=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:n.preferred_username,email:n.email,image:n.picture,emailVerified:!1,...i},data:n}},options:e}),Xi=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){const r=e.disableDefaultScope?[]:["users.read","tweet.read","offline.access","users.email"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),z({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>U({code:t,codeVerifier:r,authentication:"basic",redirectURI:n,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const{data:i,error:o}=await O("https://api.x.com/2/users/me?user.fields=confirmed_email",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});let s=!1;!o&&i?.data?.confirmed_email&&(r.data.email=i.data.confirmed_email,s=!0);const a=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.email||r.data.username||null,image:r.data.profile_image_url,emailVerified:s,...a},data:r}},options:e}),eo=e=>{const t="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:n,codeVerifier:i,redirectURI:o})=>{const s=e.disableDefaultScope?[]:["account_info.read"];return e.scope&&s.push(...e.scope),n&&s.push(...n),await z({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:r,redirectURI:o,codeVerifier:i})},validateAuthorizationCode:async({code:r,codeVerifier:n,redirectURI:i})=>await U({code:r,codeVerifier:n,redirectURI:i,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>N({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.dropbox.com/oauth2/token"}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);const{data:n,error:i}=await O("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});if(i)return null;const o=await e.mapProfileToUser?.(n);return{user:{id:n.account_id,name:n.name?.display_name,email:n.email,emailVerified:n.email_verified||!1,image:n.profile_photo_url,...o},data:n}},options:e}},to=e=>{const t="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:n,scopes:i,redirectURI:o,loginHint:s})=>{const a=e.disableDefaultScope?[]:["profile","email","openid"];return e.scope&&a.push(...e.scope),i&&a.push(...i),await z({id:"linkedin",options:e,authorizationEndpoint:t,scopes:a,state:n,loginHint:s,redirectURI:o})},validateAuthorizationCode:async({code:n,redirectURI:i})=>await U({code:n,redirectURI:i,options:e,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async n=>N({refreshToken:n,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:r}),async getUserInfo(n){if(e.getUserInfo)return e.getUserInfo(n);const{data:i,error:o}=await O("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${n.accessToken}`}});if(o)return null;const s=await e.mapProfileToUser?.(i);return{user:{id:i.sub,name:i.name,email:i.email,emailVerified:i.email_verified||!1,image:i.picture,...s},data:i}},options:e}},Ze=(e="")=>e.split("://").map(t=>t.replace(/\/{2,}/g,"/")).join("://"),ro=e=>{let t=e||"https://gitlab.com";return{authorizationEndpoint:Ze(`${t}/oauth/authorize`),tokenEndpoint:Ze(`${t}/oauth/token`),userinfoEndpoint:Ze(`${t}/api/v4/user`)}},no=e=>{const{authorizationEndpoint:t,tokenEndpoint:r,userinfoEndpoint:n}=ro(e.issuer),i="gitlab";return{id:i,name:"Gitlab",createAuthorizationURL:async({state:s,scopes:a,codeVerifier:c,loginHint:u,redirectURI:d})=>{const l=e.disableDefaultScope?[]:["read_user"];return e.scope&&l.push(...e.scope),a&&l.push(...a),await z({id:i,options:e,authorizationEndpoint:t,scopes:l,state:s,redirectURI:d,codeVerifier:c,loginHint:u})},validateAuthorizationCode:async({code:s,redirectURI:a,codeVerifier:c})=>U({code:s,redirectURI:a,options:e,codeVerifier:c,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async s=>N({refreshToken:s,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://gitlab.com/oauth/token"}),async getUserInfo(s){if(e.getUserInfo)return e.getUserInfo(s);const{data:a,error:c}=await O(n,{headers:{authorization:`Bearer ${s.accessToken}`}});if(c||a.state!=="active"||a.locked)return null;const u=await e.mapProfileToUser?.(a);return{user:{id:a.id.toString(),name:a.name??a.username,email:a.email,image:a.avatar_url,emailVerified:!0,...u},data:a}},options:e}},io=e=>({id:"tiktok",name:"TikTok",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["user.info.profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://www.tiktok.com/v2/auth/authorize?scope=${i.join(",")}&response_type=code&client_key=${e.clientKey}&client_secret=${e.clientSecret}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>U({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const r=["open_id","avatar_large_url","display_name","username"],{data:n,error:i}=await O(`https://open.tiktokapis.com/v2/user/info/?fields=${r.join(",")}`,{headers:{authorization:`Bearer ${t.accessToken}`}});return i?null:{user:{email:n.data.user.email||n.data.user.username,id:n.data.user.open_id,name:n.data.user.display_name||n.data.user.username,image:n.data.user.avatar_large_url,emailVerified:!!n.data.user.email},data:n}},options:e}),oo=e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["identity"];return e.scope&&i.push(...e.scope),r&&i.push(...r),z({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:i,state:t,redirectURI:n,duration:e.duration})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{const n=new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:e.redirectURI||r}),i={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${He.encode(`${e.clientId}:${e.clientSecret}`)}`},{data:o,error:s}=await O("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:i,body:n.toString()});if(s)throw s;return Or(o)},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.reddit.com/api/v1/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});if(n)return null;const i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...i},data:r}},options:e}),so=e=>({id:"roblox",name:"Roblox",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["openid","profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://apis.roblox.com/oauth/v1/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"select_account+consent"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>U({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://apis.roblox.com/oauth/v1/token",authentication:"post"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://apis.roblox.com/oauth/v1/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://apis.roblox.com/oauth/v1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.nickname||r.preferred_username||"",image:r.picture,email:r.preferred_username||null,emailVerified:!0,...i},data:{...r}}},options:e}),ao=e=>({id:"vk",name:"VK",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const o=e.disableDefaultScope?[]:["email","phone"];return e.scope&&o.push(...e.scope),r&&o.push(...r),z({id:"vk",options:e,authorizationEndpoint:"https://id.vk.com/authorize",scopes:o,state:t,redirectURI:i,codeVerifier:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n,deviceId:i})=>U({code:t,codeVerifier:r,redirectURI:e.redirectURI||n,options:e,deviceId:i,tokenEndpoint:"https://id.vk.com/oauth2/auth"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>N({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.vk.com/oauth2/auth"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;const r=new URLSearchParams({access_token:t.accessToken,client_id:e.clientId}).toString(),{data:n,error:i}=await O("https://id.vk.com/oauth2/user_info",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(i||!n.user.email)return null;const o=await e.mapProfileToUser?.(n);return{user:{id:n.user.user_id,first_name:n.user.first_name,last_name:n.user.last_name,email:n.user.email,image:n.user.avatar,emailVerified:!!n.user.email,birthday:n.user.birthday,sex:n.user.sex,...o},data:n}},options:e}),co=e=>({id:"kick",name:"Kick",createAuthorizationURL({state:t,scopes:r,redirectURI:n,codeVerifier:i}){const o=e.disableDefaultScope?[]:["user:read"];return e.scope&&o.push(...e.scope),r&&o.push(...r),z({id:"kick",redirectURI:n,options:e,authorizationEndpoint:"https://id.kick.com/oauth/authorize",scopes:o,codeVerifier:i,state:t})},async validateAuthorizationCode({code:t,redirectURI:r,codeVerifier:n}){return U({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.kick.com/oauth/token",codeVerifier:n})},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await O("https://api.kick.com/public/v1/users",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=r.data[0],o=await e.mapProfileToUser?.(i);return{user:{id:i.user_id,name:i.name,email:i.email,image:i.profile_picture,emailVerified:!0,...o},data:i}},options:e}),uo=e=>{const t={pkce:!0,...e};return{id:"zoom",name:"Zoom",createAuthorizationURL:async({state:r,redirectURI:n,codeVerifier:i})=>{const o=new URLSearchParams({response_type:"code",redirect_uri:t.redirectURI?t.redirectURI:n,client_id:t.clientId,state:r});if(t.pkce){const a=await Sr(i);o.set("code_challenge_method","S256"),o.set("code_challenge",a)}const s=new URL("https://zoom.us/oauth/authorize");return s.search=o.toString(),s},validateAuthorizationCode:async({code:r,redirectURI:n,codeVerifier:i})=>U({code:r,redirectURI:t.redirectURI||n,codeVerifier:i,options:t,tokenEndpoint:"https://zoom.us/oauth/token",authentication:"post"}),async getUserInfo(r){if(t.getUserInfo)return t.getUserInfo(r);const{data:n,error:i}=await O("https://api.zoom.us/v2/users/me",{headers:{authorization:`Bearer ${r.accessToken}`}});if(i)return null;const o=await t.mapProfileToUser?.(n);return{user:{id:n.id,name:n.display_name,image:n.pic_url,email:n.email,emailVerified:!!n.verified,...o},data:{...n}}}}},lo={apple:xi,discord:Wi,facebook:Ki,github:Ji,microsoft:Zi,google:Fi,huggingface:Gi,spotify:Qi,twitch:Yi,twitter:Xi,dropbox:eo,kick:co,linkedin:to,gitlab:no,tiktok:io,reddit:oo,roblox:so,vk:ao,zoom:uo},fo=Object.keys(lo),Rr=Bt(fo).or(p()),_e=e=>ir("a-z","A-Z","0-9")(e||32);w({id:p(),providerId:p(),accountId:p(),userId:Ue.string(),accessToken:p().nullish(),refreshToken:p().nullish(),idToken:p().nullish(),accessTokenExpiresAt:k().nullish(),refreshTokenExpiresAt:k().nullish(),scope:p().nullish(),password:p().nullish(),createdAt:k().default(()=>new Date),updatedAt:k().default(()=>new Date)});w({id:p(),email:p().transform(e=>e.toLowerCase()),emailVerified:Z().default(!1),name:p(),image:p().nullish(),createdAt:k().default(()=>new Date),updatedAt:k().default(()=>new Date)});w({id:p(),userId:Ue.string(),expiresAt:k(),createdAt:k().default(()=>new Date),updatedAt:k().default(()=>new Date),token:p(),ipAddress:p().nullish(),userAgent:p().nullish()});w({id:p(),value:p(),createdAt:k().default(()=>new Date),updatedAt:k().default(()=>new Date),expiresAt:k(),identifier:p()});async function po(e,t,r=3600){return await new Oi(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(t))}const vr=ye(async()=>({})),le=ye.create({use:[vr,ye(async()=>({}))]}),T=tt.create({use:[vr]});function at(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?`\\${e}`:e}function mo(e){let t="";for(let r=0;r<e.length;r++)t+=at(e[r]);return t}function kr(e,t=!0){if(Array.isArray(e))return`(?:${e.map(d=>`^${kr(d,t)}$`).join("|")})`;let r="",n="",i=".";t===!0?(r="/",n="[/\\\\]",i="[^/\\\\]"):t&&(r=t,n=mo(r),n.length>1?(n=`(?:${n})`,i=`((?!${n}).)`):i=`[^${n}]`);let o=t?`${n}+?`:"",s=t?`${n}*?`:"",a=t?e.split(r):[e],c="";for(let u=0;u<a.length;u++){let d=a[u],l=a[u+1],m="";if(!(!d&&u>0)){if(t&&(u===a.length-1?m=s:l!=="**"?m=o:m=""),t&&d==="**"){m&&(c+=u===0?"":m,c+=`(?:${i}*?${m})*?`);continue}for(let h=0;h<d.length;h++){let g=d[h];g==="\\"?h<d.length-1&&(c+=at(d[h+1]),h++):g==="?"?c+=i:g==="*"?c+=`${i}*?`:c+=at(g)}c+=m}}return c}function ho(e,t){if(typeof t!="string")throw new TypeError(`Sample must be a string, but ${typeof t} given`);return e.test(t)}function Ur(e,t){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if((typeof t=="string"||typeof t=="boolean")&&(t={separator:t}),arguments.length===2&&!(typeof t>"u"||typeof t=="object"&&t!==null&&!Array.isArray(t)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof t} given`);if(t=t||{},t.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=kr(e,t.separator),n=new RegExp(`^${r}$`,t.flags),i=ho.bind(null,n);return i.options=t,i.pattern=e,i.regexp=n,i}le(async e=>{if(e.request?.method!=="POST"||!e.request)return;const{body:t,query:r,context:n}=e,i=e.headers?.get("origin")||e.headers?.get("referer")||"",o=t?.callbackURL||r?.callbackURL,s=t?.redirectTo,a=t?.errorCallbackURL,c=t?.newUserCallbackURL,u=Array.isArray(n.options.trustedOrigins)?n.trustedOrigins:[...n.trustedOrigins,...await n.options.trustedOrigins?.(e.request)||[]],d=e.headers?.has("cookie"),l=(h,g)=>{if(h.startsWith("/"))return!1;if(g.includes("*"))return Ur(g)(qt(h));const E=xt(h);return E==="http:"||E==="https:"||!E?g===Ht(h):h.startsWith(g)},m=(h,g)=>{if(!h)return;if(!u.some(I=>l(h,I)||h?.startsWith("/")&&g!=="origin"&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(h)))throw e.context.logger.error(`Invalid ${g}: ${h}`),e.context.logger.info(`If it's a valid URL, please add ${h} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${u}`),new f("FORBIDDEN",{message:`Invalid ${g}`})};d&&!e.context.options.advanced?.disableCSRFCheck&&m(i,"origin"),o&&m(o,"callbackURL"),s&&m(s,"redirectURL"),a&&m(a,"errorCallbackURL"),c&&m(c,"newUserCallbackURL")});const pt=e=>le(async t=>{if(!t.request)return;const{context:r}=t,n=e(t),i=Array.isArray(r.options.trustedOrigins)?r.trustedOrigins:[...r.trustedOrigins,...await r.options.trustedOrigins?.(t.request)||[]],o=(c,u)=>{if(c.startsWith("/"))return!1;if(u.includes("*"))return Ur(u)(qt(c));const d=xt(c);return d==="http:"||d==="https:"||!d?u===Ht(c):c.startsWith(u)},s=(c,u)=>{if(!c)return;if(!i.some(l=>o(c,l)||c?.startsWith("/")&&u!=="origin"&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(c)))throw t.context.logger.error(`Invalid ${u}: ${c}`),t.context.logger.info(`If it's a valid URL, please add ${c} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${i}`),new f("FORBIDDEN",{message:`Invalid ${u}`})},a=Array.isArray(n)?n:[n];for(const c of a)s(c,"callbackURL")}),A={FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action.",FAILED_TO_UNLINK_LAST_ACCOUNT:"You can't unlink your last account",ACCOUNT_NOT_FOUND:"Account not found"},go=()=>T("/get-session",{method:"GET",query:$e(w({disableCookieCache:$e(Z({description:"Disable cookie cache and fetch session from database"}).or(p().transform(e=>e==="true"))).optional(),disableRefresh:Z({description:"Disable session refresh. Useful for checking session status, without updating the session"}).or(p().transform(e=>e==="true")).optional()})),requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}},required:["session","user"]}}}}}}}},async e=>{try{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return null;const r=e.getCookie(e.context.authCookies.sessionData.name),n=r?Qt(zn.decode(He.decode(r))):null;if(n&&!await Zt("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify({...n.session,expiresAt:n.expiresAt}),n.signature)){const l=e.context.authCookies.sessionData.name;return e.setCookie(l,"",{maxAge:0}),e.json(null)}const i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(n?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){const d=n.session;if(n.expiresAt<Date.now()||d.session.expiresAt<new Date){const m=e.context.authCookies.sessionData.name;e.setCookie(m,"",{maxAge:0})}else return e.json(d)}const o=await e.context.internalAdapter.findSession(t);if(e.context.session=o,!o||o.session.expiresAt<new Date)return Ae(e),o&&await e.context.internalAdapter.deleteSession(o.session.token),e.json(null);if(i||e.query?.disableRefresh)return e.json(o);const s=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(o.session.expiresAt.valueOf()-s*1e3+a*1e3<=Date.now()&&(!e.query?.disableRefresh||!e.context.options.session?.disableSessionRefresh)){const d=await e.context.internalAdapter.updateSession(o.session.token,{expiresAt:ue(e.context.sessionConfig.expiresIn,"sec"),updatedAt:new Date});if(!d)return Ae(e),e.json(null,{status:401});const l=(d.expiresAt.valueOf()-Date.now())/1e3;return await re(e,{session:d,user:o.user},!1,{maxAge:l}),e.json({session:d,user:o.user})}return await Yt(e,o),e.json(o)}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new f("INTERNAL_SERVER_ERROR",{message:A.FAILED_TO_GET_SESSION})}}),M=async(e,t)=>{if(e.context.session)return e.context.session;const r=await go()({...e,asResponse:!1,headers:e.headers,returnHeaders:!1,query:{...t,...e.query}}).catch(n=>null);return e.context.session=r,r},$=le(async e=>{const t=await M(e);if(!t?.session)throw new f("UNAUTHORIZED");return{session:t}}),wo=le(async e=>{const t=await M(e);if(!t?.session&&(e.request||e.headers))throw new f("UNAUTHORIZED");return{session:t}}),yo=le(async e=>{const t=await M(e);if(!t?.session)throw new f("UNAUTHORIZED");if(e.context.sessionConfig.freshAge===0)return{session:t};const r=e.context.sessionConfig.freshAge,n=t.session.updatedAt?.valueOf()||t.session.createdAt.valueOf();if(!(Date.now()-n<r*1e3))throw new f("FORBIDDEN",{message:"Session is not fresh"});return{session:t}});T("/revoke-session",{method:"POST",body:w({token:p({description:"The token to revoke"})}),use:[$],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"The token to revoke"}},required:["token"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the session was revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.body.token,r=await e.context.internalAdapter.findSession(t);if(!r)throw new f("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new f("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(t)}catch(n){throw e.context.logger.error(n&&typeof n=="object"&&"name"in n?n.name:"",n),new f("INTERNAL_SERVER_ERROR")}return e.json({status:!0})});T("/revoke-sessions",{method:"POST",use:[$],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&typeof t=="object"&&"name"in t?t.name:"",t),new f("INTERNAL_SERVER_ERROR")}return e.json({status:!0})});T("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[$],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all other sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.context.session;if(!t.user)throw new f("UNAUTHORIZED");const i=(await e.context.internalAdapter.listSessions(t.user.id)).filter(o=>o.expiresAt>new Date).filter(o=>o.token!==e.context.session.session.token);return await Promise.all(i.map(o=>e.context.internalAdapter.deleteSession(o.token))),e.json({status:!0})});async function be(e,t,r,n=3600){return await po({email:t.toLowerCase(),updateTo:r},e,n)}async function Pt(e,t){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new f("BAD_REQUEST",{message:"Verification email isn't enabled"});const r=await be(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:t,url:n,token:r},e.request)}T("/send-verification-email",{method:"POST",body:w({email:p({description:"The email to send the verification email to"}).email(),callbackURL:p({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to",example:"user@example.com"},callbackURL:{type:"string",description:"The URL to use for email verification callback",example:"https://example.com/callback",nullable:!0}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the email was sent successfully",example:!0}}}}}},400:{description:"Bad Request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message",example:"Verification email isn't enabled"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new f("BAD_REQUEST",{message:"Verification email isn't enabled"});const{email:t}=e.body,r=await M(e);if(!r){const n=await e.context.internalAdapter.findUserByEmail(t);return n?(await Pt(e,n.user),e.json({status:!0})):e.json({status:!0})}if(r?.user.emailVerified)throw new f("BAD_REQUEST",{message:"You can only send a verification email to an unverified email"});if(r?.user.email!==t)throw new f("BAD_REQUEST",{message:"You can only send a verification email to your own email"});return await Pt(e,r.user),e.json({status:!0})});T("/verify-email",{method:"GET",query:w({token:p({description:"The token to verify the email"}),callbackURL:p({description:"The URL to redirect to after email verification"}).optional()}),use:[pt(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",parameters:[{name:"token",in:"query",description:"The token to verify the email",required:!0,schema:{type:"string"}},{name:"callbackURL",in:"query",description:"The URL to redirect to after email verification",required:!1,schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string",description:"User ID"},email:{type:"string",description:"User email"},name:{type:"string",description:"User name"},image:{type:"string",description:"User image URL"},emailVerified:{type:"boolean",description:"Indicates if the user email is verified"},createdAt:{type:"string",description:"User creation date"},updatedAt:{type:"string",description:"User update date"}},required:["id","email","name","image","emailVerified","createdAt","updatedAt"]},status:{type:"boolean",description:"Indicates if the email was verified successfully"}},required:["user","status"]}}}}}}}},async e=>{function t(a){throw e.query.callbackURL?e.query.callbackURL.includes("?")?e.redirect(`${e.query.callbackURL}&error=${a}`):e.redirect(`${e.query.callbackURL}?error=${a}`):new f("UNAUTHORIZED",{message:a})}const{token:r}=e.query;let n;try{n=await ft(r,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(a){return a instanceof rt?t("token_expired"):t("invalid_token")}const o=w({email:p().email(),updateTo:p().optional()}).parse(n.payload),s=await e.context.internalAdapter.findUserByEmail(o.email);if(!s)return t("user_not_found");if(o.updateTo){const a=await M(e);if(!a){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}if(a.user.email!==o.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return t("unauthorized")}const c=await e.context.internalAdapter.updateUserByEmail(o.email,{email:o.updateTo,emailVerified:!1},e),u=await be(e.context.secret,o.updateTo);if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:c,url:`${e.context.baseURL}/verify-email?token=${u}&callbackURL=${e.query.callbackURL||"/"}`,token:u},e.request),await re(e,{session:a.session,user:{...a.user,email:o.updateTo,emailVerified:!1}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:{id:c.id,email:c.email,name:c.name,image:c.image,emailVerified:c.emailVerified,createdAt:c.createdAt,updatedAt:c.updatedAt}})}if(await e.context.options.emailVerification?.onEmailVerification?.(s.user,e.request),await e.context.internalAdapter.updateUserByEmail(o.email,{emailVerified:!0},e),e.context.options.emailVerification?.autoSignInAfterVerification){const a=await M(e);if(!a||a.user.email!==o.email){const c=await e.context.internalAdapter.createSession(s.user.id,e);if(!c)throw new f("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await re(e,{session:c,user:{...s.user,emailVerified:!0}})}else await re(e,{session:a.session,user:{...a.user,emailVerified:!0}})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})});const mt={isAction:!1};async function Nr(e,{userInfo:t,account:r,callbackURL:n,disableSignUp:i,overrideUserInfo:o}){const s=await e.context.internalAdapter.findOAuthUser(t.email.toLowerCase(),r.accountId,r.providerId).catch(d=>{pe.error(`Better auth was unable to query your database.
Error: `,d);const l=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${l}?error=internal_server_error`)});let a=s?.user,c=!a;if(s){const d=s.accounts.find(l=>l.providerId===r.providerId&&l.accountId===r.accountId);if(d){if(e.context.options.account?.updateAccountOnSignIn!==!1){const l=Object.fromEntries(Object.entries({accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope}).filter(([m,h])=>h!==void 0));Object.keys(l).length>0&&await e.context.internalAdapter.updateAccount(d.id,l,e)}}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!t.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return cn&&pe.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:t.id.toString(),userId:s.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope},e)}catch(h){return pe.error("Unable to link account",h),{error:"unable to link account",data:null}}}if(o){const{id:l,...m}=t;await e.context.internalAdapter.updateUser(s.user.id,{...m,email:t.email.toLowerCase(),emailVerified:t.email.toLowerCase()===s.user.email&&s.user.emailVerified||t.emailVerified})}}else{if(i)return{error:"signup disabled",data:null,isRegister:!1};try{const{id:d,...l}=t;if(a=await e.context.internalAdapter.createOAuthUser({...l,email:t.email.toLowerCase()},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:t.id.toString()},e).then(m=>m?.user),!t.emailVerified&&a&&e.context.options.emailVerification?.sendOnSignUp){const m=await be(e.context.secret,a.email,void 0,e.context.options.emailVerification?.expiresIn),h=`${e.context.baseURL}/verify-email?token=${m}&callbackURL=${n}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:a,url:h,token:m},e.request)}}catch(d){return pe.error(d),d instanceof f?{error:d.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}}if(!a)return{error:"unable to create user",data:null,isRegister:!1};const u=await e.context.internalAdapter.createSession(a.id,e);return u?{data:{session:u,user:a},error:null,isRegister:c}:{error:"unable to create session",data:null,isRegister:!1}}T("/sign-in/social",{method:"POST",body:w({callbackURL:p({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:p().optional(),errorCallbackURL:p({description:"Callback URL to redirect to if an error happens"}).optional(),provider:Rr,disableRedirect:Z({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:$e(w({token:p({description:"ID token from the provider"}),nonce:p({description:"Nonce used to generate the token"}).optional(),accessToken:p({description:"Access token from the provider"}).optional(),refreshToken:p({description:"Refresh token from the provider"}).optional(),expiresAt:zt({description:"Expiry date of the token"}).optional()}),{description:"ID token from the provider to sign in the user with id token"}),scopes:Ye(p(),{description:"Array of scopes to request from the provider. This will override the default scopes passed."}).optional(),requestSignUp:Z({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider"}).optional(),loginHint:p({description:"The login hint to use for the authorization code request"}).optional()}),metadata:{openapi:{description:"Sign in with a social provider",operationId:"socialSignIn",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token",url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}}},required:["redirect","token","user"]}}}}}}}},async e=>{const t=e.context.socialProviders.find(o=>o.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new f("NOT_FOUND",{message:A.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new f("NOT_FOUND",{message:A.ID_TOKEN_NOT_SUPPORTED});const{token:o,nonce:s}=e.body.idToken;if(!await t.verifyIdToken(o,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.INVALID_TOKEN});const c=await t.getUserInfo({idToken:o,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!c||!c?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.FAILED_TO_GET_USER_INFO});if(!c.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.USER_EMAIL_NOT_FOUND});const u=await Nr(e,{userInfo:{...c.user,email:c.user.email,id:c.user.id,name:c.user.name||"",image:c.user.image,emailVerified:c.user.emailVerified||!1},account:{providerId:t.id,accountId:c.user.id,accessToken:e.body.idToken.accessToken},callbackURL:e.body.callbackURL,disableSignUp:t.disableImplicitSignUp&&!e.body.requestSignUp||t.disableSignUp});if(u.error)throw new f("UNAUTHORIZED",{message:u.error});return await re(e,u.data),e.json({redirect:!1,token:u.data.session.token,url:void 0,user:{id:u.data.user.id,email:u.data.user.email,name:u.data.user.name,image:u.data.user.image,emailVerified:u.data.user.emailVerified,createdAt:u.data.user.createdAt,updatedAt:u.data.user.updatedAt}})}const{codeVerifier:r,state:n}=await Ir(e),i=await t.createAuthorizationURL({state:n,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`,scopes:e.body.scopes,loginHint:e.body.loginHint});return e.json({url:i.toString(),redirect:!e.body.disableRedirect})});T("/sign-in/email",{method:"POST",body:w({email:p({description:"Email of the user"}),password:p({description:"Password of the user"}),callbackURL:p({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:Z({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token"},url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}},required:["redirect","token","user"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new f("BAD_REQUEST",{message:"Email and password is not enabled"});const{email:t,password:r}=e.body;if(!p().email().safeParse(t).success)throw new f("BAD_REQUEST",{message:A.INVALID_EMAIL});const i=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!i)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new f("UNAUTHORIZED",{message:A.INVALID_EMAIL_OR_PASSWORD});const o=i.accounts.find(u=>u.providerId==="credential");if(!o)throw e.context.logger.error("Credential account not found",{email:t}),new f("UNAUTHORIZED",{message:A.INVALID_EMAIL_OR_PASSWORD});const s=o?.password;if(!s)throw e.context.logger.error("Password not found",{email:t}),new f("UNAUTHORIZED",{message:A.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:s,password:r}))throw e.context.logger.error("Invalid password"),new f("UNAUTHORIZED",{message:A.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!i.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new f("FORBIDDEN",{message:A.EMAIL_NOT_VERIFIED});const u=await be(e.context.secret,i.user.email,void 0,e.context.options.emailVerification?.expiresIn),d=`${e.context.baseURL}/verify-email?token=${u}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:i.user,url:d,token:u},e.request),new f("FORBIDDEN",{message:A.EMAIL_NOT_VERIFIED})}const c=await e.context.internalAdapter.createSession(i.user.id,e,e.body.rememberMe===!1);if(!c)throw e.context.logger.error("Failed to create session"),new f("UNAUTHORIZED",{message:A.FAILED_TO_CREATE_SESSION});return await re(e,{session:c,user:i.user},e.body.rememberMe===!1),e.json({redirect:!!e.body.callbackURL,token:c.token,url:e.body.callbackURL,user:{id:i.user.id,email:i.user.email,name:i.user.name,image:i.user.image,emailVerified:i.user.emailVerified,createdAt:i.user.createdAt,updatedAt:i.user.updatedAt}})});const Be=w({code:p().optional(),error:p().optional(),device_id:p().optional(),error_description:p().optional(),state:p().optional(),user:p().optional()});T("/callback/:id",{method:["GET","POST"],body:Be.optional(),query:Be.optional(),metadata:mt},async e=>{let t;const r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;try{if(e.method==="GET")t=Be.parse(e.query);else if(e.method==="POST")t=Be.parse(e.body);else throw new Error("Unsupported method")}catch(b){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",b),e.redirect(`${r}?error=invalid_callback_request`)}const{code:n,error:i,state:o,error_description:s,device_id:a}=t;if(i)throw e.redirect(`${r}?error=${i}&error_description=${s}`);if(!o)throw e.context.logger.error("State not found",i),e.redirect(`${r}?error=state_not_found`);const{codeVerifier:c,callbackURL:u,link:d,errorURL:l,newUserURL:m,requestSignUp:h}=await Mi(e);function g(b){let q=l||r;throw q.includes("?")?q=`${q}&error=${b}`:q=`${q}?error=${b}`,e.redirect(q)}if(!n)throw e.context.logger.error("Code not found"),g("no_code");const E=e.context.socialProviders.find(b=>b.id===e.params.id);if(!E)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),g("oauth_provider_not_found");let I;try{I=await E.validateAuthorizationCode({code:n,codeVerifier:c,deviceId:a,redirectURI:`${e.context.baseURL}/callback/${E.id}`})}catch(b){throw e.context.logger.error("",b),g("invalid_code")}const v=await E.getUserInfo({...I,user:e.body?.user?Qt(e.body.user):void 0}).then(b=>b?.user);if(!v)return e.context.logger.error("Unable to get user info"),g("unable_to_get_user_info");if(!v.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),g("email_not_found");if(!u)throw e.context.logger.error("No callback URL found"),g("no_callback_url");if(d){if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(E.id)&&!v.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return e.context.logger.error("Unable to link account - untrusted provider"),g("unable_to_link_account");const Se=await e.context.internalAdapter.findAccount(v.id);if(Se){if(Se.userId.toString()!==d.userId.toString())return g("account_already_linked_to_different_user");const ge=Object.fromEntries(Object.entries({accessToken:I.accessToken,idToken:I.idToken,refreshToken:I.refreshToken,accessTokenExpiresAt:I.accessTokenExpiresAt,refreshTokenExpiresAt:I.refreshTokenExpiresAt,scope:I.scopes?.join(",")}).filter(([Le,xe])=>xe!==void 0));await e.context.internalAdapter.updateAccount(Se.id,ge)}else if(!await e.context.internalAdapter.createAccount({userId:d.userId,providerId:E.id,accountId:v.id,...I,scope:I.scopes?.join(",")},e))return g("unable_to_link_account");let oe;try{oe=u.toString()}catch{oe=u}throw e.redirect(oe)}const _=await Nr(e,{userInfo:{...v,email:v.email,name:v.name||v.email},account:{providerId:E.id,accountId:v.id,...I,scope:I.scopes?.join(",")},callbackURL:u,disableSignUp:E.disableImplicitSignUp&&!h||E.options?.disableSignUp,overrideUserInfo:E.options?.overrideUserInfoOnSignIn});if(_.error)return e.context.logger.error(_.error.split(" ").join("_")),g(_.error.split(" ").join("_"));const{session:P,user:S}=_.data;await re(e,{session:P,user:S});let Q;try{Q=(_.isRegister&&m||u).toString()}catch{Q=_.isRegister&&m||u}throw e.redirect(Q)});T("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)throw Ae(e),new f("BAD_REQUEST",{message:A.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(t),Ae(e),e.json({success:!0})});function Ct(e,t,r){const n=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([i,o])=>n.searchParams.set(i,o)),n.href}function Eo(e,t,r){const n=new URL(t,e.baseURL);return r&&Object.entries(r).forEach(([i,o])=>n.searchParams.set(i,o)),n.href}T("/request-password-reset",{method:"POST",body:w({email:p({description:"The email address of the user to send a password reset email to"}).email(),redirectTo:p({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new f("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const i=60*60*1,o=ue(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||i,"sec"),s=_e(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${s}`,expiresAt:o},e);const a=r?encodeURIComponent(r):"",c=`${e.context.baseURL}/reset-password/${s}?callbackURL=${a}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:c,token:s},e.request),e.json({status:!0})});T("/forget-password",{method:"POST",body:w({email:p({description:"The email address of the user to send a password reset email to"}).email(),redirectTo:p({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new f("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const i=60*60*1,o=ue(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||i,"sec"),s=_e(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${s}`,expiresAt:o},e);const a=r?encodeURIComponent(r):"",c=`${e.context.baseURL}/reset-password/${s}?callbackURL=${a}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:c,token:s},e.request),e.json({status:!0})});T("/reset-password/:token",{method:"GET",query:w({callbackURL:p({description:"The URL to redirect the user to reset their password"})}),use:[pt(e=>e.query.callbackURL)],metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{const{token:t}=e.params,{callbackURL:r}=e.query;if(!t||!r)throw e.redirect(Ct(e.context,r,{error:"INVALID_TOKEN"}));const n=await e.context.internalAdapter.findVerificationValue(`reset-password:${t}`);throw!n||n.expiresAt<new Date?e.redirect(Ct(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(Eo(e.context,r,{token:t}))});T("/reset-password",{method:"POST",query:w({token:p().optional()}).optional(),body:w({newPassword:p({description:"The new password to set"}),token:p({description:"The token to reset the password"}).optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const t=e.body.token||e.query?.token;if(!t)throw new f("BAD_REQUEST",{message:A.INVALID_TOKEN});const{newPassword:r}=e.body,n=e.context.password?.config.minPasswordLength,i=e.context.password?.config.maxPasswordLength;if(r.length<n)throw new f("BAD_REQUEST",{message:A.PASSWORD_TOO_SHORT});if(r.length>i)throw new f("BAD_REQUEST",{message:A.PASSWORD_TOO_LONG});const o=`reset-password:${t}`,s=await e.context.internalAdapter.findVerificationValue(o);if(!s||s.expiresAt<new Date)throw new f("BAD_REQUEST",{message:A.INVALID_TOKEN});const a=s.value,c=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(a)).find(l=>l.providerId==="credential")?(await e.context.internalAdapter.updatePassword(a,c,e),await e.context.internalAdapter.deleteVerificationValue(s.id),e.context.options.emailAndPassword?.revokeSessionsOnPasswordReset&&await e.context.internalAdapter.deleteSessions(a),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:a,providerId:"credential",password:c,accountId:a},e),await e.context.internalAdapter.deleteVerificationValue(s.id),e.json({status:!0}))});T("/change-password",{method:"POST",body:w({newPassword:p({description:"The new password to set"}),currentPassword:p({description:"The current password"}),revokeOtherSessions:Z({description:"Revoke all other sessions"}).optional()}),use:[$],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Password successfully changed",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"New session token if other sessions were revoked"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{const{newPassword:t,currentPassword:r,revokeOtherSessions:n}=e.body,i=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)throw e.context.logger.error("Password is too short"),new f("BAD_REQUEST",{message:A.PASSWORD_TOO_SHORT});const s=e.context.password.config.maxPasswordLength;if(t.length>s)throw e.context.logger.error("Password is too long"),new f("BAD_REQUEST",{message:A.PASSWORD_TOO_LONG});const c=(await e.context.internalAdapter.findAccounts(i.user.id)).find(m=>m.providerId==="credential"&&m.password);if(!c||!c.password)throw new f("BAD_REQUEST",{message:A.CREDENTIAL_ACCOUNT_NOT_FOUND});const u=await e.context.password.hash(t);if(!await e.context.password.verify({hash:c.password,password:r}))throw new f("BAD_REQUEST",{message:A.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(c.id,{password:u});let l=null;if(n){await e.context.internalAdapter.deleteSessions(i.user.id);const m=await e.context.internalAdapter.createSession(i.user.id,e);if(!m)throw new f("INTERNAL_SERVER_ERROR",{message:A.FAILED_TO_GET_SESSION});await re(e,{session:m,user:i.user}),l=m.token}return e.json({token:l,user:{id:i.user.id,email:i.user.email,name:i.user.name,image:i.user.image,emailVerified:i.user.emailVerified,createdAt:i.user.createdAt,updatedAt:i.user.updatedAt}})});T("/set-password",{method:"POST",body:w({newPassword:p()}),metadata:{SERVER_ONLY:!0},use:[$]},async e=>{const{newPassword:t}=e.body,r=e.context.session,n=e.context.password.config.minPasswordLength;if(t.length<n)throw e.context.logger.error("Password is too short"),new f("BAD_REQUEST",{message:A.PASSWORD_TOO_SHORT});const i=e.context.password.config.maxPasswordLength;if(t.length>i)throw e.context.logger.error("Password is too long"),new f("BAD_REQUEST",{message:A.PASSWORD_TOO_LONG});const s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(c=>c.providerId==="credential"&&c.password),a=await e.context.password.hash(t);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a},e),e.json({status:!0});throw new f("BAD_REQUEST",{message:"user already has a password"})});T("/delete-user",{method:"POST",use:[$],body:w({callbackURL:p().optional(),password:p().optional(),token:p().optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"User deletion processed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the operation was successful"},message:{type:"string",enum:["User deleted","Verification email sent"],description:"Status message of the deletion process"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new f("NOT_FOUND");const t=e.context.session;if(e.body.password){const o=(await e.context.internalAdapter.findAccounts(t.user.id)).find(a=>a.providerId==="credential"&&a.password);if(!o||!o.password)throw new f("BAD_REQUEST",{message:A.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:o.password,password:e.body.password}))throw new f("BAD_REQUEST",{message:A.INVALID_PASSWORD})}if(e.body.token)return await To({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){const i=ot(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`delete-account-${i}`,expiresAt:new Date(Date.now()+(e.context.options.user.deleteUser?.deleteTokenExpiresIn||60*60*24)*1e3)},e);const o=`${e.context.baseURL}/delete-user/callback?token=${i}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:t.user,url:o,token:i},e.request),e.json({success:!0,message:"Verification email sent"})}if(!e.body.password&&e.context.sessionConfig.freshAge!==0){const i=t.session.createdAt.getTime(),o=e.context.sessionConfig.freshAge*1e3;if(Date.now()-i>o*1e3)throw new f("BAD_REQUEST",{message:A.SESSION_EXPIRED})}const r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),Ae(e);const n=e.context.options.user.deleteUser?.afterDelete;return n&&await n(t.user,e.request),e.json({success:!0,message:"User deleted"})});const To=T("/delete-user/callback",{method:"GET",query:w({token:p(),callbackURL:p().optional()}),use:[pt(e=>e.query.callbackURL)],metadata:{openapi:{description:"Callback to complete user deletion with verification token",responses:{200:{description:"User successfully deleted",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the deletion was successful"},message:{type:"string",enum:["User deleted"],description:"Confirmation message"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new f("NOT_FOUND");const t=await M(e);if(!t)throw new f("NOT_FOUND",{message:A.FAILED_TO_GET_USER_INFO});const r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw new f("NOT_FOUND",{message:A.INVALID_TOKEN});if(r.value!==t.user.id)throw new f("NOT_FOUND",{message:A.INVALID_TOKEN});const n=e.context.options.user.deleteUser?.beforeDelete;n&&await n(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),Ae(e);const i=e.context.options.user.deleteUser?.afterDelete;if(i&&await i(t.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})});T("/change-email",{method:"POST",body:w({newEmail:p({description:"The new email to set"}).email(),callbackURL:p({description:"The URL to redirect to after email verification"}).optional()}),use:[$],metadata:{openapi:{responses:{200:{description:"Email change request processed successfully",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the request was successful"},message:{type:"string",enum:["Email updated","Verification email sent"],description:"Status message of the email change process",nullable:!0}},required:["status"]}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new f("BAD_REQUEST",{message:"Change email is disabled"});const t=e.body.newEmail.toLowerCase();if(t===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new f("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(t))throw e.context.logger.error("Email already exists"),new f("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){if(await e.context.internalAdapter.findUserByEmail(t))throw new f("UNPROCESSABLE_ENTITY",{message:A.USER_ALREADY_EXISTS});if(await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:t},e),await re(e,{session:e.context.session.session,user:{...e.context.session.user,email:t}}),e.context.options.emailVerification?.sendVerificationEmail){const s=await be(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),a=`${e.context.baseURL}/verify-email?token=${s}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:a,token:s},e.request)}return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new f("BAD_REQUEST",{message:"Verification email isn't enabled"});const n=await be(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn),i=`${e.context.baseURL}/verify-email?token=${n}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:t,url:i,token:n},e.request),e.json({status:!0})});function Ao(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const bo=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon"></div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${Ao(e)}</span></div>
    </div>
</body>
</html>`;T("/error",{method:"GET",metadata:{...mt,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string",description:"The HTML content of the error page"}}}}}}}},async e=>{const t=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(bo(t),{headers:{"Content-Type":"text/html"}})});T("/ok",{method:"GET",metadata:{...mt,openapi:{description:"Check if the API is working",responses:{200:{description:"API is working",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean",description:"Indicates if the API is working"}},required:["ok"]}}}}}}}},async e=>e.json({ok:!0}));T("/list-accounts",{method:"GET",use:[$],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},provider:{type:"string"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},accountId:{type:"string"},scopes:{type:"array",items:{type:"string"}}},required:["id","provider","createdAt","updatedAt","accountId","scopes"]}}}}}}}},async e=>{const t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(n=>({id:n.id,provider:n.providerId,createdAt:n.createdAt,updatedAt:n.updatedAt,accountId:n.accountId,scopes:n.scope?.split(",")||[]})))});T("/link-social",{method:"POST",requireHeaders:!0,body:w({callbackURL:p({description:"The URL to redirect to after the user has signed in"}).optional(),provider:Rr,idToken:w({token:p(),nonce:p().optional(),accessToken:p().optional(),refreshToken:p().optional(),scopes:Ye(p()).optional()}).optional(),requestSignUp:Z().optional(),scopes:Ye(p(),{description:"Additional scopes to request from the provider"}).optional(),errorCallbackURL:p({description:"The URL to redirect to if there is an error during the link process"}).optional()}),use:[$],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",description:"The authorization URL to redirect the user to"},redirect:{type:"boolean",description:"Indicates if the user should be redirected to the authorization URL"},status:{type:"boolean"}},required:["redirect"]}}}}}}}},async e=>{const t=e.context.session,r=e.context.socialProviders.find(o=>o.id===e.body.provider);if(!r)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new f("NOT_FOUND",{message:A.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!r.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new f("NOT_FOUND",{message:A.ID_TOKEN_NOT_SUPPORTED});const{token:o,nonce:s}=e.body.idToken;if(!await r.verifyIdToken(o,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.INVALID_TOKEN});const c=await r.getUserInfo({idToken:o,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!c||!c?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.FAILED_TO_GET_USER_INFO});if(!c.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new f("UNAUTHORIZED",{message:A.USER_EMAIL_NOT_FOUND});if((await e.context.internalAdapter.findAccounts(t.user.id)).find(h=>h.providerId===r.id&&h.accountId===c.user.id))return e.json({redirect:!1,url:"",status:!0});if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.id)&&!c.user.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)throw new f("UNAUTHORIZED",{message:"Account not linked - linking not allowed"});if(c.user.email!==t.user.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)throw new f("UNAUTHORIZED",{message:"Account not linked - different emails not allowed"});try{await e.context.internalAdapter.createAccount({userId:t.user.id,providerId:r.id,accountId:c.user.id.toString(),accessToken:e.body.idToken.accessToken,idToken:o,refreshToken:e.body.idToken.refreshToken,scope:e.body.idToken.scopes?.join(",")},e)}catch{throw new f("EXPECTATION_FAILED",{message:"Account not linked - unable to create account"})}if(e.context.options.account?.accountLinking?.updateUserInfoOnLink===!0)try{await e.context.internalAdapter.updateUser(t.user.id,{name:c.user?.name,image:c.user?.image})}catch(h){console.warn("Could not update user - "+h.toString())}return e.json({redirect:!1,url:"",status:!0})}const n=await Ir(e,{userId:t.user.id,email:t.user.email}),i=await r.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${r.id}`,scopes:e.body.scopes});return e.json({url:i.toString(),redirect:!0})});T("/unlink-account",{method:"POST",body:w({providerId:p(),accountId:p().optional()}),use:[yo],metadata:{openapi:{description:"Unlink an account",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const{providerId:t,accountId:r}=e.body,n=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(n.length===1&&!e.context.options.account?.accountLinking?.allowUnlinkingAll)throw new f("BAD_REQUEST",{message:A.FAILED_TO_UNLINK_LAST_ACCOUNT});const i=n.find(o=>r?o.accountId===r&&o.providerId===t:o.providerId===t);if(!i)throw new f("BAD_REQUEST",{message:A.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(i.id),e.json({status:!0})});const _o=T("/get-access-token",{method:"POST",body:w({providerId:p({description:"The provider ID for the OAuth provider"}),accountId:p({description:"The account ID associated with the refresh token"}).optional(),userId:p({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Get a valid access token, doing a refresh if needed",responses:{200:{description:"A Valid access token",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,i=e.request,o=await M(e);if(i&&!o)throw e.error("UNAUTHORIZED");let s=o?.user?.id||n;if(!s)throw new f("BAD_REQUEST",{message:"Either userId or session is required"});if(!e.context.socialProviders.find(d=>d.id===t))throw new f("BAD_REQUEST",{message:`Provider ${t} is not supported.`});const c=(await e.context.internalAdapter.findAccounts(s)).find(d=>r?d.id===r&&d.providerId===t:d.providerId===t);if(!c)throw new f("BAD_REQUEST",{message:"Account not found"});const u=e.context.socialProviders.find(d=>d.id===t);if(!u)throw new f("BAD_REQUEST",{message:`Provider ${t} not found.`});try{let d=null;c.refreshToken&&(!c.accessTokenExpiresAt||c.accessTokenExpiresAt.getTime()-Date.now()<5e3)&&u.refreshAccessToken&&(d=await u.refreshAccessToken(c.refreshToken),await e.context.internalAdapter.updateAccount(c.id,{accessToken:d.accessToken,accessTokenExpiresAt:d.accessTokenExpiresAt,refreshToken:d.refreshToken,refreshTokenExpiresAt:d.refreshTokenExpiresAt}));const l={accessToken:d?.accessToken??c.accessToken??void 0,accessTokenExpiresAt:d?.accessTokenExpiresAt??c.accessTokenExpiresAt??void 0,scopes:c.scope?.split(",")??[],idToken:d?.idToken??c.idToken??void 0};return e.json(l)}catch(d){throw new f("BAD_REQUEST",{message:"Failed to get a valid access token",cause:d})}});T("/refresh-token",{method:"POST",body:w({providerId:p({description:"The provider ID for the OAuth provider"}),accountId:p({description:"The account ID associated with the refresh token"}).optional(),userId:p({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Refresh the access token using a refresh token",responses:{200:{description:"Access token refreshed successfully",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,i=e.request,o=await M(e);if(i&&!o)throw e.error("UNAUTHORIZED");let s=o?.user?.id||n;if(!s)throw new f("BAD_REQUEST",{message:"Either userId or session is required"});if(!e.context.socialProviders.find(d=>d.id===t))throw new f("BAD_REQUEST",{message:`Provider ${t} is not supported.`});const c=(await e.context.internalAdapter.findAccounts(s)).find(d=>r?d.id===r&&d.providerId===t:d.providerId===t);if(!c)throw new f("BAD_REQUEST",{message:"Account not found"});const u=e.context.socialProviders.find(d=>d.id===t);if(!u)throw new f("BAD_REQUEST",{message:`Provider ${t} not found.`});if(!u.refreshAccessToken)throw new f("BAD_REQUEST",{message:`Provider ${t} does not support token refreshing.`});try{const d=await u.refreshAccessToken(c.refreshToken);return await e.context.internalAdapter.updateAccount(c.id,{accessToken:d.accessToken,accessTokenExpiresAt:d.accessTokenExpiresAt,refreshToken:d.refreshToken,refreshTokenExpiresAt:d.refreshTokenExpiresAt}),e.json(d)}catch(d){throw new f("BAD_REQUEST",{message:"Failed to refresh access token",cause:d})}});T("/account-info",{method:"POST",use:[$],metadata:{openapi:{description:"Get the account info provided by the provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string"},name:{type:"string"},email:{type:"string"},image:{type:"string"},emailVerified:{type:"boolean"}},required:["id","emailVerified"]},data:{type:"object",properties:{},additionalProperties:!0}},required:["user","data"],additionalProperties:!1}}}}}}},body:w({accountId:p({description:"The provider given account id for which to get the account info"})})},async e=>{const t=await e.context.internalAdapter.findAccount(e.body.accountId);if(!t||t.userId!==e.context.session.user.id)throw new f("BAD_REQUEST",{message:"Account not found"});const r=e.context.socialProviders.find(o=>o.id===t.providerId);if(!r)throw new f("INTERNAL_SERVER_ERROR",{message:`Provider account provider is ${t.providerId} but it is not configured`});const n=await _o({...e,body:{accountId:t.id,providerId:t.providerId},returnHeaders:!1}),i=await r.getUserInfo(n);return e.json(i)});function Io(e){return{authorize(t,r="AND"){let n=!1;for(const[i,o]of Object.entries(t)){const s=e[i];if(!s)return{success:!1,error:`You are not allowed to access resource: ${i}`};if(Array.isArray(o))n=o.every(a=>s.includes(a));else if(typeof o=="object"){const a=o;a.connector==="OR"?n=a.actions.some(c=>s.includes(c)):n=a.actions.every(c=>s.includes(c))}else throw new Te("Invalid access control request");if(n&&r==="OR")return{success:n};if(!n&&r==="AND")return{success:!1,error:`unauthorized to access resource "${i}"`}}return n?{success:n}:{success:!1,error:"Not authorized"}},statements:e}}function So(e){return{newRole(t){return Io(t)},statements:e}}const Oo={organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"]},ht=So(Oo),Ro=ht.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"],team:["create","update","delete"]}),vo=ht.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"]}),ko=ht.newRole({organization:[],member:[],invitation:[],team:[]}),Uo={admin:Ro,owner:vo,member:ko},Ie=e=>{if(!e.permissions&&!e.permission)return!1;const t=e.role.split(","),r=e.options.roles||Uo;for(const n of t)if(r[n]?.authorize(e.permissions??e.permission)?.success)return!0;return!1},D=(e,t)=>{const r=e.adapter;return{findOrganizationBySlug:async n=>await r.findOne({model:"organization",where:[{field:"slug",value:n}]}),createOrganization:async n=>{const i=await r.create({model:"organization",data:{...n.organization,metadata:n.organization.metadata?JSON.stringify(n.organization.metadata):void 0}});return{...i,metadata:i.metadata?JSON.parse(i.metadata):void 0}},findMemberByEmail:async n=>{const i=await r.findOne({model:"user",where:[{field:"email",value:n.email}]});if(!i)return null;const o=await r.findOne({model:"member",where:[{field:"organizationId",value:n.organizationId},{field:"userId",value:i.id}]});return o?{...o,user:{id:i.id,name:i.name,email:i.email,image:i.image}}:null},listMembers:async n=>await r.findMany({model:"member",where:[{field:"organizationId",value:n.organizationId}],limit:t?.membershipLimit||100}),findMemberByOrgId:async n=>{const[i,o]=await Promise.all([await r.findOne({model:"member",where:[{field:"userId",value:n.userId},{field:"organizationId",value:n.organizationId}]}),await r.findOne({model:"user",where:[{field:"id",value:n.userId}]})]);return!o||!i?null:{...i,user:{id:o.id,name:o.name,email:o.email,image:o.image}}},findMemberById:async n=>{const i=await r.findOne({model:"member",where:[{field:"id",value:n}]});if(!i)return null;const o=await r.findOne({model:"user",where:[{field:"id",value:i.userId}]});return o?{...i,user:{id:o.id,name:o.name,email:o.email,image:o.image}}:null},createMember:async n=>await r.create({model:"member",data:{...n,createdAt:new Date}}),updateMember:async(n,i)=>await r.update({model:"member",where:[{field:"id",value:n}],update:{role:i}}),deleteMember:async n=>await r.delete({model:"member",where:[{field:"id",value:n}]}),updateOrganization:async(n,i)=>{const o=await r.update({model:"organization",where:[{field:"id",value:n}],update:{...i,metadata:typeof i.metadata=="object"?JSON.stringify(i.metadata):i.metadata}});return o?{...o,metadata:o.metadata?Kt(o.metadata):void 0}:null},deleteOrganization:async n=>(await r.delete({model:"member",where:[{field:"organizationId",value:n}]}),await r.delete({model:"invitation",where:[{field:"organizationId",value:n}]}),await r.delete({model:"organization",where:[{field:"id",value:n}]}),n),setActiveOrganization:async(n,i)=>await e.internalAdapter.updateSession(n,{activeOrganizationId:i}),findOrganizationById:async n=>await r.findOne({model:"organization",where:[{field:"id",value:n}]}),findFullOrganization:async({organizationId:n,isSlug:i,includeTeams:o})=>{const s=await r.findOne({model:"organization",where:[{field:i?"slug":"id",value:n}]});if(!s)return null;const[a,c,u]=await Promise.all([r.findMany({model:"invitation",where:[{field:"organizationId",value:s.id}]}),r.findMany({model:"member",where:[{field:"organizationId",value:s.id}],limit:t?.membershipLimit||100}),o?r.findMany({model:"team",where:[{field:"organizationId",value:s.id}]}):null]);if(!s)return null;const d=c.map(g=>g.userId),l=d.length>0?await r.findMany({model:"user",where:[{field:"id",value:d,operator:"in"}],limit:t?.membershipLimit||100}):[],m=new Map(l.map(g=>[g.id,g])),h=c.map(g=>{const E=m.get(g.userId);if(!E)throw new Te("Unexpected error: User not found for member");return{...g,user:{id:E.id,name:E.name,email:E.email,image:E.image}}});return{...s,invitations:a,members:h,teams:u}},listOrganizations:async n=>{const i=await r.findMany({model:"member",where:[{field:"userId",value:n}]});if(!i||i.length===0)return[];const o=i.map(a=>a.organizationId);return await r.findMany({model:"organization",where:[{field:"id",value:o,operator:"in"}]})},createTeam:async n=>await r.create({model:"team",data:n}),findTeamById:async({teamId:n,organizationId:i,includeTeamMembers:o})=>{const s=await r.findOne({model:"team",where:[{field:"id",value:n},...i?[{field:"organizationId",value:i}]:[]]});if(!s)return null;let a=[];return o?(a=await r.findMany({model:"member",where:[{field:"teamId",value:n}],limit:t?.membershipLimit||100}),{...s,members:a}):s},updateTeam:async(n,i)=>await r.update({model:"team",where:[{field:"id",value:n}],update:{...i}}),deleteTeam:async n=>await r.delete({model:"team",where:[{field:"id",value:n}]}),listTeams:async n=>await r.findMany({model:"team",where:[{field:"organizationId",value:n}]}),createTeamInvitation:async({email:n,role:i,teamId:o,organizationId:s,inviterId:a,expiresIn:c=1e3*60*60*48})=>{const u=ue(c);return await r.create({model:"invitation",data:{email:n,role:i,organizationId:s,teamId:o,inviterId:a,status:"pending",expiresAt:u}})},findInvitationsByTeamId:async n=>await r.findMany({model:"invitation",where:[{field:"teamId",value:n}]}),createInvitation:async({invitation:n,user:i})=>{const s=ue(t?.invitationExpiresIn||172800,"sec");return await r.create({model:"invitation",data:{status:"pending",expiresAt:s,inviterId:i.id,...n}})},findInvitationById:async n=>await r.findOne({model:"invitation",where:[{field:"id",value:n}]}),findPendingInvitation:async n=>(await r.findMany({model:"invitation",where:[{field:"email",value:n.email},{field:"organizationId",value:n.organizationId},{field:"status",value:"pending"}]})).filter(o=>new Date(o.expiresAt)>new Date),findPendingInvitations:async n=>(await r.findMany({model:"invitation",where:[{field:"organizationId",value:n.organizationId},{field:"status",value:"pending"}]})).filter(o=>new Date(o.expiresAt)>new Date),listInvitations:async n=>await r.findMany({model:"invitation",where:[{field:"organizationId",value:n.organizationId}]}),updateInvitation:async n=>await r.update({model:"invitation",where:[{field:"id",value:n.invitationId}],update:{status:n.status}})}},L=le(async e=>({})),ie=le({use:[$]},async e=>({session:e.context.session})),y={YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",MEMBER_NOT_FOUND:"Member not found",TEAM_NOT_FOUND:"Team not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization",FAILED_TO_RETRIEVE_INVITATION:"Failed to retrieve invitation",UNABLE_TO_REMOVE_LAST_TEAM:"Unable to remove last team",ORGANIZATION_MEMBERSHIP_LIMIT_REACHED:"Organization membership limit reached",YOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION:"You are not allowed to delete teams in this organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM:"You are not allowed to update this team",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM:"You are not allowed to delete this team",TEAM_MEMBER_LIMIT_REACHED:"Team member limit reached"};T("/organization/accept-invitation",{method:"POST",body:w({invitationId:p({description:"The ID of the invitation to accept"})}),use:[L,ie],metadata:{openapi:{description:"Accept an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"object"}}}}}}}}}},async e=>{const t=e.context.session,r=D(e.context,e.context.orgOptions),n=await r.findInvitationById(e.body.invitationId);if(!n||n.expiresAt<new Date||n.status!=="pending")throw new f("BAD_REQUEST",{message:y.INVITATION_NOT_FOUND});if(n.email.toLowerCase()!==t.user.email.toLowerCase())throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});const i=e.context.orgOptions?.membershipLimit||100;if((await r.listMembers({organizationId:n.organizationId})).length>=i)throw new f("FORBIDDEN",{message:y.ORGANIZATION_MEMBERSHIP_LIMIT_REACHED});const s=await r.updateInvitation({invitationId:e.body.invitationId,status:"accepted"});if(!s)throw new f("BAD_REQUEST",{message:y.FAILED_TO_RETRIEVE_INVITATION});if(e.context.orgOptions.teams&&e.context.orgOptions.teams.enabled&&typeof e.context.orgOptions.teams.maximumMembersPerTeam<"u"&&"teamId"in s&&s.teamId){const c=await r.findTeamById({teamId:s.teamId,organizationId:n.organizationId,includeTeamMembers:!0});if(!c)throw new f("BAD_REQUEST",{message:y.TEAM_NOT_FOUND});const u=typeof e.context.orgOptions.teams.maximumMembersPerTeam=="function"?await e.context.orgOptions.teams.maximumMembersPerTeam({teamId:s.teamId,session:t,organizationId:n.organizationId}):e.context.orgOptions.teams.maximumMembersPerTeam;if(c.members.length>=u)throw new f("FORBIDDEN",{message:y.TEAM_MEMBER_LIMIT_REACHED})}const a=await r.createMember({organizationId:n.organizationId,userId:t.user.id,role:n.role,createdAt:new Date,..."teamId"in s?{teamId:s.teamId}:{}});return await r.setActiveOrganization(t.session.token,n.organizationId),s?e.json({invitation:s,member:a}):e.json(null,{status:400,body:{message:y.INVITATION_NOT_FOUND}})});T("/organization/reject-invitation",{method:"POST",body:w({invitationId:p({description:"The ID of the invitation to reject"})}),use:[L,ie],metadata:{openapi:{description:"Reject an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"null"}}}}}}}}}},async e=>{const t=e.context.session,r=D(e.context,e.context.orgOptions),n=await r.findInvitationById(e.body.invitationId);if(!n||n.expiresAt<new Date||n.status!=="pending")throw new f("BAD_REQUEST",{message:"Invitation not found!"});if(n.email.toLowerCase()!==t.user.email.toLowerCase())throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});const i=await r.updateInvitation({invitationId:e.body.invitationId,status:"rejected"});return e.json({invitation:i,member:null})});T("/organization/cancel-invitation",{method:"POST",body:w({invitationId:p({description:"The ID of the invitation to cancel"})}),use:[L,ie],openapi:{description:"Cancel an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"}}}}}}}}},async e=>{const t=e.context.session,r=D(e.context,e.context.orgOptions),n=await r.findInvitationById(e.body.invitationId);if(!n)throw new f("BAD_REQUEST",{message:y.INVITATION_NOT_FOUND});const i=await r.findMemberByOrgId({userId:t.user.id,organizationId:n.organizationId});if(!i)throw new f("BAD_REQUEST",{message:y.MEMBER_NOT_FOUND});if(!Ie({role:i.role,options:e.context.orgOptions,permissions:{invitation:["cancel"]}}))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION});const s=await r.updateInvitation({invitationId:e.body.invitationId,status:"canceled"});return e.json(s)});T("/organization/get-invitation",{method:"GET",use:[L],requireHeaders:!0,query:w({id:p({description:"The ID of the invitation to get"})}),metadata:{openapi:{description:"Get an invitation by ID",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"},organizationName:{type:"string"},organizationSlug:{type:"string"},inviterEmail:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt","organizationName","organizationSlug","inviterEmail"]}}}}}}}},async e=>{const t=await M(e);if(!t)throw new f("UNAUTHORIZED",{message:"Not authenticated"});const r=D(e.context,e.context.orgOptions),n=await r.findInvitationById(e.query.id);if(!n||n.status!=="pending"||n.expiresAt<new Date)throw new f("BAD_REQUEST",{message:"Invitation not found!"});if(n.email.toLowerCase()!==t.user.email.toLowerCase())throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});const i=await r.findOrganizationById(n.organizationId);if(!i)throw new f("BAD_REQUEST",{message:y.ORGANIZATION_NOT_FOUND});const o=await r.findMemberByOrgId({userId:n.inviterId,organizationId:n.organizationId});if(!o)throw new f("BAD_REQUEST",{message:y.INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION});return e.json({...n,organizationName:i.name,organizationSlug:i.slug,inviterEmail:o.user.email})});T("/organization/list-invitations",{method:"GET",use:[L,ie],query:w({organizationId:p({description:"The ID of the organization to list invitations for"}).optional()}).optional()},async e=>{const t=await M(e);if(!t)throw new f("UNAUTHORIZED",{message:"Not authenticated"});const r=e.query?.organizationId||t.session.activeOrganizationId;if(!r)throw new f("BAD_REQUEST",{message:"Organization ID is required"});const n=D(e.context,e.context.orgOptions);if(!await n.findMemberByOrgId({userId:t.user.id,organizationId:r}))throw new f("FORBIDDEN",{message:"You are not a member of this organization"});const o=await n.listInvitations({organizationId:r});return e.json(o)});T("/organization/remove-member",{method:"POST",body:w({memberIdOrEmail:p({description:"The ID or email of the member to remove"}),organizationId:p({description:"The ID of the organization to remove the member from. If not provided, the active organization will be used"}).optional()}),use:[L,ie],metadata:{openapi:{description:"Remove a member from an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async e=>{const t=e.context.session,r=e.body.organizationId||t.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:y.NO_ACTIVE_ORGANIZATION}});const n=D(e.context,e.context.orgOptions),i=await n.findMemberByOrgId({userId:t.user.id,organizationId:r});if(!i)throw new f("BAD_REQUEST",{message:y.MEMBER_NOT_FOUND});let o=null;if(e.body.memberIdOrEmail.includes("@")?o=await n.findMemberByEmail({email:e.body.memberIdOrEmail,organizationId:r}):o=await n.findMemberById(e.body.memberIdOrEmail),!o)throw new f("BAD_REQUEST",{message:y.MEMBER_NOT_FOUND});const s=o.role.split(","),a=e.context.orgOptions?.creatorRole||"owner";if(s.includes(a)){if(i.role!==a)throw new f("BAD_REQUEST",{message:y.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER});if((await n.listMembers({organizationId:r})).filter(m=>m.role.split(",").includes(a)).length<=1)throw new f("BAD_REQUEST",{message:y.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER})}if(!Ie({role:i.role,options:e.context.orgOptions,permissions:{member:["delete"]}}))throw new f("UNAUTHORIZED",{message:y.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER});if(o?.organizationId!==r)throw new f("BAD_REQUEST",{message:y.MEMBER_NOT_FOUND});return await n.deleteMember(o.id),t.user.id===o.userId&&t.session.activeOrganizationId===o.organizationId&&await n.setActiveOrganization(t.session.token,null),e.json({member:o})});T("/organization/get-active-member",{method:"GET",use:[L,ie],metadata:{openapi:{description:"Get the member details of the active organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}}}}}}}},async e=>{const t=e.context.session,r=t.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:y.NO_ACTIVE_ORGANIZATION}});const i=await D(e.context,e.context.orgOptions).findMemberByOrgId({userId:t.user.id,organizationId:r});return i?e.json(i):e.json(null,{status:400,body:{message:y.MEMBER_NOT_FOUND}})});T("/organization/leave",{method:"POST",body:w({organizationId:p()}),use:[$,L]},async e=>{const t=e.context.session,r=D(e.context),n=await r.findMemberByOrgId({userId:t.user.id,organizationId:e.body.organizationId});if(!n)throw new f("BAD_REQUEST",{message:y.MEMBER_NOT_FOUND});if(n.role===(e.context.orgOptions?.creatorRole||"owner")&&(await e.context.adapter.findMany({model:"member",where:[{field:"organizationId",value:e.body.organizationId}]})).filter(a=>a.role===(e.context.orgOptions?.creatorRole||"owner")).length<=1)throw new f("BAD_REQUEST",{message:y.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER});return await r.deleteMember(n.id),t.session.activeOrganizationId===e.body.organizationId&&await r.setActiveOrganization(t.session.token,null),e.json(n)});T("/organization/create",{method:"POST",body:w({name:p({description:"The name of the organization"}),slug:p({description:"The slug of the organization"}),userId:Ue.string({description:"The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server."}).optional(),logo:p({description:"The logo of the organization"}).optional(),metadata:ct(p(),Mt(),{description:"The metadata of the organization"}).optional(),keepCurrentActiveOrganization:Z({description:"Whether to keep the current active organization active after creating a new one"}).optional()}),use:[L],metadata:{openapi:{description:"Create an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization that was created",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{const t=await M(e);if(!t&&(e.request||e.headers))throw new f("UNAUTHORIZED");let r=t?.user||null;if(!r){if(!e.body.userId)throw new f("UNAUTHORIZED");r=await e.context.internalAdapter.findUserById(e.body.userId)}if(!r)return e.json(null,{status:401});const n=e.context.orgOptions;if(!(typeof n?.allowUserToCreateOrganization=="function"?await n.allowUserToCreateOrganization(r):n?.allowUserToCreateOrganization===void 0?!0:n.allowUserToCreateOrganization))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION});const o=D(e.context,n),s=await o.listOrganizations(r.id);if(typeof n.organizationLimit=="number"?s.length>=n.organizationLimit:typeof n.organizationLimit=="function"?await n.organizationLimit(r):!1)throw new f("FORBIDDEN",{message:y.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS});if(await o.findOrganizationBySlug(e.body.slug))throw new f("BAD_REQUEST",{message:y.ORGANIZATION_ALREADY_EXISTS});let u;if(n.organizationCreation?.beforeCreate){const m=await n.organizationCreation.beforeCreate({organization:{slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata},user:r},e.request);m&&typeof m=="object"&&"data"in m&&(u=m)}const d=await o.createOrganization({organization:{slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata,...u?.data||{}}});let l;if(n?.teams?.enabled&&n.teams.defaultTeam?.enabled!==!1){const m=await n.teams.defaultTeam?.customCreateDefaultTeam?.(d,e.request)||await o.createTeam({organizationId:d.id,name:`${d.name}`,createdAt:new Date});l=await o.createMember({teamId:m.id,userId:r.id,organizationId:d.id,role:e.context.orgOptions.creatorRole||"owner"})}else l=await o.createMember({userId:r.id,organizationId:d.id,role:e.context.orgOptions.creatorRole||"owner"});return n.organizationCreation?.afterCreate&&await n.organizationCreation.afterCreate({organization:d,user:r,member:l},e.request),e.context.session&&!e.body.keepCurrentActiveOrganization&&await o.setActiveOrganization(e.context.session.session.token,d.id),e.json({...d,metadata:e.body.metadata,members:[l]})});T("/organization/check-slug",{method:"POST",body:w({slug:p()}),use:[wo,L]},async e=>{if(!await D(e.context).findOrganizationBySlug(e.body.slug))return e.json({status:!0});throw new f("BAD_REQUEST",{message:"slug is taken"})});T("/organization/update",{method:"POST",body:w({data:w({name:p({description:"The name of the organization"}).optional(),slug:p({description:"The slug of the organization"}).optional(),logo:p({description:"The logo of the organization"}).optional(),metadata:ct(p(),Mt(),{description:"The metadata of the organization"}).optional()}).partial(),organizationId:p().optional()}),requireHeaders:!0,use:[L],metadata:{openapi:{description:"Update an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The updated organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{const t=await e.context.getSession(e);if(!t)throw new f("UNAUTHORIZED",{message:"User not found"});const r=e.body.organizationId||t.session.activeOrganizationId;if(!r)throw new f("BAD_REQUEST",{message:y.ORGANIZATION_NOT_FOUND});const n=D(e.context,e.context.orgOptions),i=await n.findMemberByOrgId({userId:t.user.id,organizationId:r});if(!i)throw new f("BAD_REQUEST",{message:y.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});if(!Ie({permissions:{organization:["update"]},role:i.role,options:e.context.orgOptions}))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION});const s=await n.updateOrganization(r,e.body.data);return e.json(s)});T("/organization/delete",{method:"POST",body:w({organizationId:p({description:"The organization id to delete"})}),requireHeaders:!0,use:[L],metadata:{openapi:{description:"Delete an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string",description:"The organization id that was deleted"}}}}}}}},async e=>{const t=await e.context.getSession(e);if(!t)return e.json(null,{status:401});const r=e.body.organizationId;if(!r)return e.json(null,{status:400,body:{message:y.ORGANIZATION_NOT_FOUND}});const n=D(e.context,e.context.orgOptions),i=await n.findMemberByOrgId({userId:t.user.id,organizationId:r});if(!i)return e.json(null,{status:400,body:{message:y.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});if(!Ie({role:i.role,permissions:{organization:["delete"]},options:e.context.orgOptions}))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION});r===t.session.activeOrganizationId&&await n.setActiveOrganization(t.session.token,null);const s=e.context.orgOptions.organizationDeletion;if(s?.disabled)throw new f("FORBIDDEN");const a=await n.findOrganizationById(r);if(!a)throw new f("BAD_REQUEST");return s?.beforeDelete&&await s.beforeDelete({organization:a,user:t.user}),await n.deleteOrganization(r),s?.afterDelete&&await s.afterDelete({organization:a,user:t.user}),e.json(a)});T("/organization/list",{method:"GET",use:[L,ie],metadata:{openapi:{description:"List all organizations",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Organization"}}}}}}}}},async e=>{const r=await D(e.context,e.context.orgOptions).listOrganizations(e.context.session.user.id);return e.json(r)});const Dr=p(),No=Bt(["pending","accepted","rejected","canceled"]).default("pending");w({id:p().default(_e),name:p(),slug:p(),logo:p().nullish().optional(),metadata:ct(p()).or(p().transform(e=>JSON.parse(e))).optional(),createdAt:k()});w({id:p().default(_e),organizationId:p(),userId:Ue.string(),role:Dr,createdAt:k().default(()=>new Date),teamId:p().optional()});w({id:p().default(_e),organizationId:p(),email:p(),role:Dr,status:No,teamId:p().optional(),inviterId:p(),expiresAt:k()});const Do=w({id:p().default(_e),name:p().min(1),organizationId:p(),createdAt:k(),updatedAt:k().optional()});T("/organization/remove-team",{method:"POST",body:w({teamId:p(),organizationId:p().optional()}),use:[L],metadata:{openapi:{description:"Remove a team from an organization",responses:{200:{description:"Team removed successfully",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Confirmation message indicating successful removal",enum:["Team removed successfully."]}},required:["message"]}}}}}}}},async e=>{const t=await M(e),r=e.body.organizationId||t?.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:y.NO_ACTIVE_ORGANIZATION}});if(!t&&(e.request||e.headers))throw new f("UNAUTHORIZED");const n=D(e.context,e.context.orgOptions);if(t){const o=await n.findMemberByOrgId({userId:t.user.id,organizationId:r});if(!o||o.teamId===e.body.teamId)throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM});if(!Ie({role:o.role,options:e.context.orgOptions,permissions:{team:["delete"]}}))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION})}const i=await n.findTeamById({teamId:e.body.teamId,organizationId:r});if(!i||i.organizationId!==r)throw new f("BAD_REQUEST",{message:y.TEAM_NOT_FOUND});if(!e.context.orgOptions.teams?.allowRemovingAllTeams&&(await n.listTeams(r)).length<=1)throw new f("BAD_REQUEST",{message:y.UNABLE_TO_REMOVE_LAST_TEAM});return await n.deleteTeam(i.id),e.json({message:"Team removed successfully."})});T("/organization/update-team",{method:"POST",body:w({teamId:p(),data:Do.partial()}),use:[L,ie],metadata:{openapi:{description:"Update an existing team in an organization",responses:{200:{description:"Team updated successfully",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",description:"Unique identifier of the updated team"},name:{type:"string",description:"Updated name of the team"},organizationId:{type:"string",description:"ID of the organization the team belongs to"},createdAt:{type:"string",format:"date-time",description:"Timestamp when the team was created"},updatedAt:{type:"string",format:"date-time",description:"Timestamp when the team was last updated"}},required:["id","name","organizationId","createdAt","updatedAt"]}}}}}}}},async e=>{const t=e.context.session,r=e.body.data.organizationId||t.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:y.NO_ACTIVE_ORGANIZATION}});const n=D(e.context,e.context.orgOptions),i=await n.findMemberByOrgId({userId:t.user.id,organizationId:r});if(!i)throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM});if(!Ie({role:i.role,options:e.context.orgOptions,permissions:{team:["update"]}}))throw new f("FORBIDDEN",{message:y.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM});const s=await n.findTeamById({teamId:e.body.teamId,organizationId:r});if(!s||s.organizationId!==r)throw new f("BAD_REQUEST",{message:y.TEAM_NOT_FOUND});const a=await n.updateTeam(s.id,{name:e.body.data.name});return e.json(a)});T("/organization/list-teams",{method:"GET",query:$e(w({organizationId:p().optional()})),metadata:{openapi:{description:"List all teams in an organization",responses:{200:{description:"Teams retrieved successfully",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string",description:"Unique identifier of the team"},name:{type:"string",description:"Name of the team"},organizationId:{type:"string",description:"ID of the organization the team belongs to"},createdAt:{type:"string",format:"date-time",description:"Timestamp when the team was created"},updatedAt:{type:"string",format:"date-time",description:"Timestamp when the team was last updated"}},required:["id","name","organizationId","createdAt","updatedAt"]},description:"Array of team objects within the organization"}}}}}}},use:[L,ie]},async e=>{const t=e.context.session,r=t.session.activeOrganizationId||e.query?.organizationId;if(!r)return e.json(null,{status:400,body:{message:y.NO_ACTIVE_ORGANIZATION}});const n=D(e.context,e.context.orgOptions);if(!await n.findMemberByOrgId({userId:t?.user.id,organizationId:r||""}))throw new f("FORBIDDEN");const o=await n.listTeams(r);return e.json(o)});w({id:p(),publicKey:p(),privateKey:p(),createdAt:k()});const Lo=()=>({id:"react-start-cookies",hooks:{after:[{matcher(e){return!0},handler:le(async e=>{const t=e.context.responseHeaders;if(!("_flag"in e&&e._flag==="router")&&t instanceof Headers){const r=t?.get("set-cookie");if(!r)return;const n=Bn(r),{setCookie:i}=await Pr(async()=>{const{setCookie:o}=await import("./server-DUznqEvH.js");return{setCookie:o}},__vite__mapDeps([0,1,2]));n.forEach((o,s)=>{if(!s)return;const a={sameSite:o.samesite,secure:o.secure,maxAge:o["max-age"],httpOnly:o.httponly,domain:o.domain,path:o.path};try{i(s,decodeURIComponent(o.value),a)}catch{}});return}})}]}}),Qe=Dn({baseURL:"http://localhost:20257",plugins:[Lo()]}),Bo=function(){const{data:t,refetch:r}=Qe.useSession(),n=async()=>{await Qe.signIn.social({provider:"github"}),r()},i=async()=>{await Qe.signOut(),r()};return se.jsxs("div",{className:"p-2",children:[se.jsx("h3",{className:"text-xl font-bold",children:"Better-Auth GitHub Sign In"}),se.jsx("div",{className:"p-4",children:t?se.jsxs("div",{children:[se.jsxs("p",{children:["Welcome, ",t.user?.email]}),se.jsx("button",{onClick:i,className:"mt-2 px-4 py-2 bg-red-500 text-white rounded",children:"Sign Out"})]}):se.jsx("button",{onClick:n,className:"px-4 py-2 bg-blue-500 text-white rounded",children:"Sign In with GitHub"})}),se.jsx("pre",{className:"mt-4 bg-gray-100 p-4 rounded",children:JSON.stringify(t,null,2)})]})};export{Bo as component};
