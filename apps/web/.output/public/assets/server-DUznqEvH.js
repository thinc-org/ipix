import{A as T,B as E}from"./main-DS40ZeVL.js";import{AsyncLocalStorage as P}from"node:async_hooks";const g=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function _(t,r){r?r={...g,...r}:r=g;const s=b(r);return s.dispatch(t),s.toString()}const N=Object.freeze(["prototype","__proto__","constructor"]);function b(t){let r="",s=new Map;const n=e=>{r+=e};return{toString(){return r},getContext(){return s},dispatch(e){return t.replacer&&(e=t.replacer(e)),this[e===null?"null":typeof e](e)},object(e){if(e&&typeof e.toJSON=="function")return this.object(e.toJSON());const i=Object.prototype.toString.call(e);let a="";const o=i.length;o<10?a="unknown:["+i+"]":a=i.slice(8,o-1),a=a.toLowerCase();let h=null;if((h=s.get(e))===void 0)s.set(e,s.size);else return this.dispatch("[CIRCULAR:"+h+"]");if(typeof Buffer<"u"&&Buffer.isBuffer&&Buffer.isBuffer(e))return n("buffer:"),n(e.toString("utf8"));if(a!=="object"&&a!=="function"&&a!=="asyncfunction")this[a]?this[a](e):t.ignoreUnknown||this.unkown(e,a);else{let u=Object.keys(e);t.unorderedObjects&&(u=u.sort());let d=[];t.respectType!==!1&&!m(e)&&(d=N),t.excludeKeys&&(u=u.filter(l=>!t.excludeKeys(l)),d=d.filter(l=>!t.excludeKeys(l))),n("object:"+(u.length+d.length)+":");const p=l=>{this.dispatch(l),n(":"),t.excludeValues||this.dispatch(e[l]),n(",")};for(const l of u)p(l);for(const l of d)p(l)}},array(e,i){if(i=i===void 0?t.unorderedArrays!==!1:i,n("array:"+e.length+":"),!i||e.length<=1){for(const h of e)this.dispatch(h);return}const a=new Map,o=e.map(h=>{const u=b(t);u.dispatch(h);for(const[d,p]of u.getContext())a.set(d,p);return u.toString()});return s=a,o.sort(),this.array(o,!1)},date(e){return n("date:"+e.toJSON())},symbol(e){return n("symbol:"+e.toString())},unkown(e,i){if(n(i),!!e&&(n(":"),e&&typeof e.entries=="function"))return this.array(Array.from(e.entries()),!0)},error(e){return n("error:"+e.toString())},boolean(e){return n("bool:"+e)},string(e){n("string:"+e.length+":"),n(e)},function(e){n("fn:"),m(e)?this.dispatch("[native]"):this.dispatch(e.toString()),t.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(e.name)),t.respectFunctionProperties&&this.object(e)},number(e){return n("number:"+e)},xml(e){return n("xml:"+e.toString())},null(){return n("Null")},undefined(){return n("Undefined")},regexp(e){return n("regex:"+e.toString())},uint8array(e){return n("uint8array:"),this.dispatch(Array.prototype.slice.call(e))},uint8clampedarray(e){return n("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(e))},int8array(e){return n("int8array:"),this.dispatch(Array.prototype.slice.call(e))},uint16array(e){return n("uint16array:"),this.dispatch(Array.prototype.slice.call(e))},int16array(e){return n("int16array:"),this.dispatch(Array.prototype.slice.call(e))},uint32array(e){return n("uint32array:"),this.dispatch(Array.prototype.slice.call(e))},int32array(e){return n("int32array:"),this.dispatch(Array.prototype.slice.call(e))},float32array(e){return n("float32array:"),this.dispatch(Array.prototype.slice.call(e))},float64array(e){return n("float64array:"),this.dispatch(Array.prototype.slice.call(e))},arraybuffer(e){return n("arraybuffer:"),this.dispatch(new Uint8Array(e))},url(e){return n("url:"+e.toString())},map(e){n("map:");const i=[...e];return this.array(i,t.unorderedSets!==!1)},set(e){n("set:");const i=[...e];return this.array(i,t.unorderedSets!==!1)},file(e){return n("file:"),this.dispatch([e.name,e.size,e.type,e.lastModfied])},blob(){if(t.ignoreUnknown)return n("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return n("domwindow")},bigint(e){return n("bigint:"+e.toString())},process(){return n("process")},timer(){return n("timer")},pipe(){return n("pipe")},tcp(){return n("tcp")},udp(){return n("udp")},tty(){return n("tty")},statwatcher(){return n("statwatcher")},securecontext(){return n("securecontext")},connection(){return n("connection")},zlib(){return n("zlib")},context(){return n("context")},nodescript(){return n("nodescript")},httpparser(){return n("httpparser")},dataview(){return n("dataview")},signal(){return n("signal")},fsevent(){return n("fsevent")},tlswrap(){return n("tlswrap")}}}const A="[native code] }",C=A.length;function m(t){return typeof t!="function"?!1:Function.prototype.toString.call(t).slice(-C)===A}function w(t,r){try{return r in t}catch{return!1}}var F=Object.defineProperty,O=(t,r,s)=>r in t?F(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,f=(t,r,s)=>(O(t,typeof r!="symbol"?r+"":r,s),s);class M extends Error{constructor(r,s={}){super(r,s),f(this,"statusCode",500),f(this,"fatal",!1),f(this,"unhandled",!1),f(this,"statusMessage"),f(this,"data"),f(this,"cause"),s.cause&&!this.cause&&(this.cause=s.cause)}toJSON(){const r={message:this.message,statusCode:x(this.statusCode,500)};return this.statusMessage&&(r.statusMessage=S(this.statusMessage)),this.data!==void 0&&(r.data=this.data),r}}f(M,"__h3_error__",!0);const U=/[^\u0009\u0020-\u007E]/g;function S(t=""){return t.replace(U,"")}function x(t,r=200){return!t||(typeof t=="string"&&(t=Number.parseInt(t,10)),t<100||t>999)?r:t}function B(t,r,s,n){n={path:"/",...n};const e=T(r,s,n);let i=t.node.res.getHeader("set-cookie");Array.isArray(i)||(i=[i]);const a=_(n);i=i.filter(o=>o&&a!==_(E(o))),t.node.res.setHeader("set-cookie",[...i,e])}function v(t){if(Array.isArray(t))return t.flatMap(d=>v(d));if(typeof t!="string")return[];const r=[];let s=0,n,e,i,a,o;const h=()=>{for(;s<t.length&&/\s/.test(t.charAt(s));)s+=1;return s<t.length},u=()=>(e=t.charAt(s),e!=="="&&e!==";"&&e!==",");for(;s<t.length;){for(n=s,o=!1;h();)if(e=t.charAt(s),e===","){for(i=s,s+=1,h(),a=s;s<t.length&&u();)s+=1;s<t.length&&t.charAt(s)==="="?(o=!0,s=a,r.push(t.slice(n,i)),n=s):s=i+1}else s+=1;(!o||s>=t.length)&&r.push(t.slice(n))}return r}function L(t,r){if(!r||typeof r!="object")throw new Error("[h3] Invalid stream provided.");if(t.node.res._data=r,!t.node.res.socket)return t._handled=!0,Promise.resolve();if(w(r,"pipeTo")&&typeof r.pipeTo=="function")return r.pipeTo(new WritableStream({write(s){t.node.res.write(s)}})).then(()=>{t.node.res.end()});if(w(r,"pipe")&&typeof r.pipe=="function")return new Promise((s,n)=>{r.pipe(t.node.res),r.on&&(r.on("end",()=>{t.node.res.end(),s()}),r.on("error",e=>{n(e)})),t.node.res.on("close",()=>{r.abort&&r.abort()})});throw new Error("[h3] Invalid or incompatible stream provided.")}function z(t,r){for(const[s,n]of r.headers)s==="set-cookie"?t.node.res.appendHeader(s,v(n)):t.node.res.setHeader(s,n);if(r.status&&(t.node.res.statusCode=x(r.status,t.node.res.statusCode)),r.statusText&&(t.node.res.statusMessage=S(r.statusText)),r.redirected&&t.node.res.setHeader("location",r.url),!r.body){t.node.res.end();return}return L(t,r.body)}var I=Object.defineProperty,K=(t,r,s)=>r in t?I(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,c=(t,r,s)=>(K(t,typeof r!="symbol"?r+"":r,s),s);class y{constructor(r,s){c(this,"__is_event__",!0),c(this,"node"),c(this,"web"),c(this,"context",{}),c(this,"_method"),c(this,"_path"),c(this,"_headers"),c(this,"_requestBody"),c(this,"_handled",!1),c(this,"_onBeforeResponseCalled"),c(this,"_onAfterResponseCalled"),this.node={req:r,res:s}}get method(){return this._method||(this._method=(this.node.req.method||"GET").toUpperCase()),this._method}get path(){return this._path||this.node.req.url||"/"}get headers(){return this._headers||(this._headers=$(this.node.req.headers)),this._headers}get handled(){return this._handled||this.node.res.writableEnded||this.node.res.headersSent}respondWith(r){return Promise.resolve(r).then(s=>z(this,s))}toString(){return`[${this.method}] ${this.path}`}toJSON(){return this.toString()}get req(){return this.node.req}get res(){return this.node.res}}function $(t){const r=new Headers;for(const[s,n]of Object.entries(t))if(Array.isArray(n))for(const e of n)r.append(s,e);else n&&r.set(s,n);return r}const q=new P;function R(){const t=q.getStore();if(!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");return t}const H=Symbol("$HTTPEvent");function W(t){return typeof t=="object"&&(t instanceof y||t?.[H]instanceof y||t?.__is_event__===!0)}function J(t){return function(...r){const s=r[0];return W(s)?r[0]=s instanceof y||s.__is_event__?s:s[H]:r.unshift(R()),t(...r)}}const D=J(B);export{M as H3Error,y as H3Event,H as HTTPEventSymbol,R as getEvent,W as isEvent,x as sanitizeStatusCode,S as sanitizeStatusMessage,D as setCookie,v as splitCookiesString};
